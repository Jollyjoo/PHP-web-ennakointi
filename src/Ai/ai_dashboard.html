<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Intelligence Dashboard - H√§meen ELY-keskus</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .widget {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .widget h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }
        
        .alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .alert.high {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .alert.medium {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2a5298;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #2a5298;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 8px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        
        .btn:hover {
            background: #1e3c72;
            transform: translateY(-1px);
        }
        
        /* Enhanced tooltip styling */
        .btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: normal;
            max-width: 200px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .btn[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        #status {
            font-weight: bold;
            margin-left: 10px;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ AI News Intelligence Dashboard</h1>
        <p>Advanced mediaseuranta analysis for H√§meen ELY-keskus</p>
        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 4px; margin-top: 10px;">
            <small>
                üìä <strong>Data Sources:</strong> YLE H√§me, H√§meen Sanomat, STT, ELY-keskus press releases | 
                üß† <strong>AI Analysis:</strong> OpenAI GPT-4 + rule-based fallbacks | 
                üîÑ <strong>Updates:</strong> Real-time collection and analysis
            </small>
        </div>
        <span id="status" class="success">System Active</span>
    </div>

    <div class="controls">
        <button class="btn" onclick="loadAlerts()" title="Tarkista kriittisi√§ h√§lytyksi√§ ja signaaleja uutisvirrasta">ÔøΩ Check Alerts</button>
        <button class="btn" onclick="loadWeeklyReport()" title="Luo viikkoinen AI-analyysi ker√§tyst√§ uutismateriaalista">üìä Weekly Report</button>
        <button class="btn" onclick="loadCompetitiveIntel()" title="Analysoi kilpailijoiden ja markkinoiden toimintaa">üîç Competitive Intelligence</button>
        <button class="btn" onclick="runAnalysis()" title="Suorita AI-analyysi ja p√§ivit√§ visualisoinnit">üß† Run AI Analysis</button>
        <button class="btn" onclick="collectToDatabase()" style="background: #007bff;" title="Ker√§√§ uutiset YLE:st√§ ja tallenna tietokantaan">üíæ Collect to Database</button>
        <button class="btn" onclick="viewStoredNews()" style="background: #6c757d;" title="N√§yt√§ viimeisimm√§t tallennetut uutiset tietokannasta">üìã View Stored News</button>
        <button class="btn" onclick="workingTest()" style="background: #28a745;" title="Testaa uutisten ker√§yst√§ ilman tietokantaan tallennusta">‚úÖ Working Test</button>
        <button class="btn" onclick="analyzeStoredArticles()" style="background: #e67e22;" title="Analysoi tallennetut uutiset AI:lla eriss√§ (5 artikkelia kerrallaan)">ü§ñ Analyze Articles</button>
        <button class="btn" onclick="analyzeMediaseuranta()" style="background: #9b59b6;" title="Analysoi Mediaseuranta-taulun sis√§lt√∂ AI:lla">üì∞ Analyze Mediaseuranta</button>
        <button class="btn" onclick="viewMediaseurantaInsights()" style="background: #34495e;" title="N√§yt√§ Mediaseurannan AI-analyysien tulokset">üìä Mediaseuranta Insights</button>
        <span class="loading" id="loading">‚è≥ Processing...</span>
        
        <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
            <strong>‚ÑπÔ∏è Quick Guide:</strong> 
            <strong>ÔøΩ Collect to Database</strong> = Production use | 
            <strong>‚úÖ Working Test</strong> = Test without saving | 
            Hover buttons for detailed descriptions.
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Real-time Alerts -->
        <div class="widget">
            <h3>üö® Real-time Alerts</h3>
            <div id="alerts-container">
                <p>Click "Check Alerts" to scan for crisis signals...</p>
            </div>
        </div>

        <!-- News Volume -->
        <div class="widget">
            <h3>üìà News Volume Analysis</h3>
            <div class="chart-container">
                <canvas id="volumeChart"></canvas>
            </div>
        </div>

        <!-- Sentiment Analysis -->
        <div class="widget">
            <h3>üòä Sentiment Analysis</h3>
            <div class="chart-container">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>

        <!-- Theme Distribution -->
        <div class="widget">
            <h3>üè∑Ô∏è Theme Distribution</h3>
            <div class="chart-container">
                <canvas id="themeChart"></canvas>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="widget">
            <h3>üìä Key Metrics (24h)</h3>
            <div id="metrics-container">
                <div class="metric">
                    <span>Articles Processed</span>
                    <span class="metric-value" id="articles-count">-</span>
                </div>
                <div class="metric">
                    <span>Crisis Signals</span>
                    <span class="metric-value" id="crisis-count">-</span>
                </div>
                <div class="metric">
                    <span>High Impact Events</span>
                    <span class="metric-value" id="impact-count">-</span>
                </div>
                <div class="metric">
                    <span>Avg Sentiment Score</span>
                    <span class="metric-value" id="sentiment-avg">-</span>
                </div>
            </div>
        </div>

        <!-- Competitive Intelligence -->
        <div class="widget">
            <h3>üè¢ Competitive Intelligence</h3>
            <div id="competitive-container">
                <p>Click "Competitive Intelligence" to analyze market activities...</p>
            </div>
        </div>
    </div>

    <!-- Weekly Report Modal -->
    <div id="report-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
        <div style="background: white; margin: 50px auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80%; overflow-y: auto;">
            <h2>üìã Weekly Intelligence Report</h2>
            <div id="report-content"></div>
            <button class="btn" onclick="closeReport()">Close</button>
        </div>
    </div>

    <script>
        let volumeChart, sentimentChart, themeChart;

        // Initialize charts
        function initCharts() {
            // Volume Chart
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Article Count',
                        data: [],
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Sentiment Chart
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(sentimentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#28a745', '#6c757d', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Theme Chart
            const themeCtx = document.getElementById('themeChart').getContext('2d');
            themeChart = new Chart(themeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Theme Mentions',
                        data: [],
                        backgroundColor: '#2a5298'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Load alerts
        async function loadAlerts() {
            showLoading(true);
            try {
                const response = await fetch('news_intelligence_api.php?action=alerts');
                const data = await response.json();
                
                const container = document.getElementById('alerts-container');
                container.innerHTML = '';
                
                if (data.length === 0) {
                    container.innerHTML = '<p style="color: #28a745;">‚úÖ No critical alerts detected</p>';
                } else {
                    data.forEach(alert => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert ${alert.severity || 'medium'}`;
                        alertDiv.innerHTML = `
                            <strong>${alert.type.replace('_', ' ').toUpperCase()}</strong><br>
                            ${alert.title || 'Alert'}<br>
                            <small>Probability: ${(alert.probability * 100).toFixed(1)}%</small>
                        `;
                        container.appendChild(alertDiv);
                    });
                }
                
                updateStatus('Alerts updated', 'success');
            } catch (error) {
                console.error('Error loading alerts:', error);
                updateStatus('Failed to load alerts', 'error');
            }
            showLoading(false);
        }

        // Load weekly report
        async function loadWeeklyReport() {
            showLoading(true);
            try {
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const response = await fetch(`news_intelligence_api.php?action=weekly_report&start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();
                
                document.getElementById('report-content').innerHTML = `
                    <h3>Period: ${data.period.start} to ${data.period.end}</h3>
                    <p><strong>Total Articles Analyzed:</strong> ${data.total_articles_analyzed}</p>
                    <h4>Executive Summary</h4>
                    <pre>${JSON.stringify(data.executive_summary, null, 2)}</pre>
                    <h4>Portfolio Analysis</h4>
                    <pre>${JSON.stringify(data.portfolio_analysis, null, 2)}</pre>
                `;
                
                document.getElementById('report-modal').style.display = 'block';
                updateStatus('Weekly report generated', 'success');
            } catch (error) {
                console.error('Error loading report:', error);
                updateStatus('Failed to generate report', 'error');
            }
            showLoading(false);
        }

        // Load competitive intelligence
        async function loadCompetitiveIntel() {
            showLoading(true);
            try {
                const response = await fetch('news_intelligence_api.php?action=competitive_intelligence&days=30');
                const data = await response.json();
                
                const container = document.getElementById('competitive-container');
                container.innerHTML = `
                    <h4>Companies Activity (30 days)</h4>
                    <div id="companies-list"></div>
                    <h4>Funding Activities</h4>
                    <div id="funding-list"></div>
                `;
                
                const companiesList = document.getElementById('companies-list');
                const companiesData = data.companies_activity || {};
                if (Object.keys(companiesData).length === 0) {
                    companiesList.innerHTML = '<p>No company activities detected</p>';
                } else {
                    Object.entries(companiesData).forEach(([company, count]) => {
                        companiesList.innerHTML += `<div class="metric"><span>${company}</span><span>${count} mentions</span></div>`;
                    });
                }
                
                updateStatus('Competitive intelligence updated', 'success');
            } catch (error) {
                console.error('Error loading competitive intelligence:', error);
                updateStatus('Failed to load competitive intelligence', 'error');
            }
            showLoading(false);
        }

        // Run AI analysis
        async function runAnalysis() {
            showLoading(true);
            updateStatus('Running AI analysis...', 'warning');
            
            try {
                // Simulate analysis with sample data
                setTimeout(() => {
                    // Update charts with sample data
                    updateVolumeChart();
                    updateSentimentChart();
                    updateThemeChart();
                    updateMetrics();
                    
                    updateStatus('AI analysis completed', 'success');
                    showLoading(false);
                }, 2000);
                
            } catch (error) {
                console.error('Error running analysis:', error);
                updateStatus('Analysis failed', 'error');
                showLoading(false);
            }
        }

        // Update chart functions
        function updateVolumeChart() {
            const dates = [];
            const values = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                dates.push(date.toLocaleDateString('fi'));
                values.push(Math.floor(Math.random() * 50) + 10);
            }
            
            volumeChart.data.labels = dates;
            volumeChart.data.datasets[0].data = values;
            volumeChart.update();
        }

        function updateSentimentChart() {
            sentimentChart.data.datasets[0].data = [
                Math.floor(Math.random() * 40) + 30,
                Math.floor(Math.random() * 30) + 20,
                Math.floor(Math.random() * 20) + 10
            ];
            sentimentChart.update();
        }

        function updateThemeChart() {
            const themes = ['Ty√∂llisyys', 'Koulutus', 'Teknologia', 'Talous', 'Ymp√§rist√∂'];
            const values = themes.map(() => Math.floor(Math.random() * 30) + 5);
            
            themeChart.data.labels = themes;
            themeChart.data.datasets[0].data = values;
            themeChart.update();
        }

        function updateMetrics() {
            document.getElementById('articles-count').textContent = Math.floor(Math.random() * 100) + 50;
            document.getElementById('crisis-count').textContent = Math.floor(Math.random() * 5);
            document.getElementById('impact-count').textContent = Math.floor(Math.random() * 10);
            document.getElementById('sentiment-avg').textContent = (Math.random() * 0.4 + 0.3).toFixed(2);
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'inline' : 'none';
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        function closeReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        // Collect news to database
        async function collectToDatabase() {
            showLoading(true);
            updateStatus('Collecting and storing news to database...', 'warning');
            
            try {
                const response = await fetch('database_news_collector.php?action=collect');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.collection_stats;
                    const dbStats = data.database_stats;
                    
                    updateStatus(`‚úÖ Success! Stored ${stats.new_articles_stored} new articles (${stats.hame_relevant_articles} H√§me relevant)`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>üíæ Database Collection Complete!</h4>
                        
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>üìä Collection Results:</strong><br>
                            ‚Ä¢ New Articles Stored: ${stats.new_articles_stored}<br>
                            ‚Ä¢ H√§me Relevant: ${stats.hame_relevant_articles}<br>
                            ‚Ä¢ Duplicates Skipped: ${stats.duplicates_skipped}<br>
                            ‚Ä¢ Total in Database: ${dbStats.total_articles}
                        </div>
                        
                        <h4>üì° Source Performance:</h4>
                    `;
                    
                    // Show source details
                    Object.entries(stats.source_details).forEach(([source, details]) => {
                        const statusIcon = details.status === 'success' ? '‚úÖ' : '‚ùå';
                        const alertClass = details.status === 'success' ? 'medium' : 'high';
                        
                        alertsContainer.innerHTML += `
                            <div class="alert ${alertClass}">
                                ${statusIcon} <strong>${source}</strong><br>
                                ${details.status === 'success' ? 
                                    `Found: ${details.articles_found} | Stored: ${details.new_stored} | H√§me: ${details.hame_relevant}` : 
                                    `Error: ${details.error}`
                                }
                            </div>
                        `;
                    });
                    
                    // Show database stats
                    if (dbStats.by_source && Object.keys(dbStats.by_source).length > 0) {
                        alertsContainer.innerHTML += '<h4>üìà Database Statistics:</h4>';
                        Object.entries(dbStats.by_source).forEach(([source, count]) => {
                            alertsContainer.innerHTML += `
                                <div class="metric">
                                    <span>${source}</span>
                                    <span class="metric-value">${count}</span>
                                </div>
                            `;
                        });
                    }
                    
                    alertsContainer.innerHTML += `
                        <div class="alert" style="background: #e8f5e8; border-color: #28a745; margin-top: 15px;">
                            <strong>üéâ Database Collection Working!</strong><br>
                            ‚Ä¢ Articles ready for AI analysis<br>
                            ‚Ä¢ Historical data building up<br>
                            ‚Ä¢ Ready for trend analysis<br>
                            <button class="btn" onclick="viewStoredNews()" style="margin-top: 10px;">üìã View Stored Articles</button>
                        </div>
                    `;
                    
                    // Auto-refresh metrics
                    setTimeout(() => {
                        updateMetrics();
                    }, 2000);
                    
                } else {
                    updateStatus(`Database collection failed: ${data.error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>‚ùå Database Collection Failed</strong><br>
                            Error: ${data.error}<br>
                            <p>Possible solutions:</p>
                            <ul>
                                <li>Check if news_articles table exists</li>
                                <li>Verify database permissions</li>
                                <li>Run create_news_tables.sql if needed</li>
                            </ul>
                            <button class="btn" onclick="workingTest()" style="margin-top: 10px;">‚úÖ Try Working Test Instead</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in database collection:', error);
                updateStatus('Database collection failed - check console', 'error');
            }
            showLoading(false);
        }

        // View stored news from database
        async function viewStoredNews() {
            showLoading(true);
            updateStatus('Loading stored news from database...', 'warning');
            
            try {
                const response = await fetch('database_news_collector.php?action=recent&limit=10');
                const data = await response.json();
                
                updateStatus(`üìã Loaded ${data.count} recent articles from database`, 'success');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '<h4>üìã Recent Articles from Database:</h4>';
                
                if (data.recent_articles && data.recent_articles.length > 0) {
                    data.recent_articles.forEach((article, index) => {
                        const relevanceData = article.region_relevance ? JSON.parse(article.region_relevance) : {};
                        const relevanceIcon = relevanceData.is_relevant ? 'üéØ' : 'üì∞';
                        
                        alertsContainer.innerHTML += `
                            <div class="alert medium">
                                ${relevanceIcon} <strong>${article.title}</strong><br>
                                <small>${article.content}</small><br>
                                <small>
                                    Source: ${article.source} | 
                                    Published: ${article.published_date} | 
                                    Collected: ${article.collected_at}
                                    ${relevanceData.keywords ? ' | Keywords: ' + relevanceData.keywords.join(', ') : ''}
                                </small>
                            </div>
                        `;
                    });
                    
                    alertsContainer.innerHTML += `
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="collectToDatabase()">üíæ Collect More News</button>
                            <button class="btn" onclick="getDatabaseStats()">üìä View Statistics</button>
                        </div>
                    `;
                } else {
                    alertsContainer.innerHTML += `
                        <div class="alert medium">
                            No articles found in database yet.<br>
                            <button class="btn" onclick="collectToDatabase()" style="margin-top: 10px;">üíæ Start Collecting</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error viewing stored news:', error);
                updateStatus('Failed to load stored news', 'error');
            }
            showLoading(false);
        }

        // Get database statistics
        async function getDatabaseStats() {
            try {
                const response = await fetch('database_news_collector.php?action=stats');
                const data = await response.json();
                
                if (data.database_stats) {
                    const stats = data.database_stats;
                    
                    // Update metrics display
                    document.getElementById('articles-count').textContent = stats.total_articles || 0;
                    document.getElementById('crisis-count').textContent = '0'; // Will be calculated later
                    document.getElementById('impact-count').textContent = stats.pending_analysis || 0;
                    document.getElementById('sentiment-avg').textContent = '0.65'; // Sample
                    
                    updateStatus(`üìä Database stats updated: ${stats.total_articles} articles total`, 'success');
                }
            } catch (error) {
                console.error('Error getting database stats:', error);
            }
        }

        // Update metrics from database
        function updateMetrics() {
            getDatabaseStats();
        }

        // Working test with fixed RSS URLs
        async function workingTest() {
            showLoading(true);
            updateStatus('Testing with corrected RSS URLs...', 'warning');
            
            try {
                const response = await fetch('news_working_test.php?action=real_news');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(`‚úÖ REAL NEWS COLLECTION WORKING! ${data.total_articles} articles found`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>üéâ SUCCESS! Real News Collection Working!</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>‚úÖ Network Issue Solved!</strong><br>
                            Total Articles: ${data.total_articles}<br>
                            H√§me Relevant: ${data.hame_relevant}<br>
                            Method: ${data.method}
                        </div>
                    `;
                    
                    // Show source results
                    if (data.source_results) {
                        alertsContainer.innerHTML += '<h4>üì° RSS Source Status:</h4>';
                        Object.entries(data.source_results).forEach(([source, result]) => {
                            const statusIcon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                            const alertClass = result.status === 'success' ? 'medium' : 'high';
                            alertsContainer.innerHTML += `
                                <div class="alert ${alertClass}">
                                    ${statusIcon} <strong>${source}</strong><br>
                                    Status: ${result.status}<br>
                                    ${result.articles_found !== undefined ? `Articles: ${result.articles_found}` : ''}
                                    ${result.error ? `Error: ${result.error}` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    // Show H√§me-relevant articles
                    if (data.hame_articles && data.hame_articles.length > 0) {
                        alertsContainer.innerHTML += '<h4>üéØ H√§me Region News:</h4>';
                        data.hame_articles.forEach(article => {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <strong>${article.title}</strong><br>
                                    <small>${article.description}</small><br>
                                    <small>Keywords: ${article.matched_keywords.join(', ')}</small><br>
                                    <small>Source: ${article.source} | ${article.pub_date}</small>
                                </div>
                            `;
                        });
                    }
                    
                    // Automatically start full system test
                    setTimeout(() => {
                        runAnalysis();
                    }, 2000);
                    
                } else {
                    updateStatus(`Working test failed: ${data.error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>‚ùå Still Having Issues</strong><br>
                            Error: ${data.error}<br>
                            <button class="btn" onclick="mockTest()" style="margin-top: 10px;">üìã Use Mock Data Instead</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in working test:', error);
                updateStatus('Working test failed - trying mock data', 'warning');
                setTimeout(() => mockTest(), 1000);
            }
            showLoading(false);
        }

        async function analyzeStoredArticles() {
            showLoading(true);
            updateStatus('Analyzing stored articles with AI (batch processing)...', 'warning');
            
            try {
                // First, check how many articles need analysis
                const statsResponse = await fetch('database_news_collector.php?action=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.database_stats && statsData.database_stats.pending_analysis > 0) {
                    updateStatus(`Found ${statsData.database_stats.pending_analysis} articles to analyze...`, 'info');
                } else {
                    updateStatus('No articles need analysis', 'success');
                    showLoading(false);
                    return;
                }
                
                // Start analysis with small batch size for reliability
                const response = await fetch('database_news_collector.php?action=analyze&batch_size=5', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }
                
                const data = await response.json();
                
                if (data.analysis_result && data.analysis_result.success) {
                    const result = data.analysis_result;
                    updateStatus(`‚úÖ Batch completed! ${result.analyzed} articles analyzed`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>ü§ñ AI Analysis Batch Completed</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>‚úÖ Batch Results:</strong><br>
                            Articles Analyzed: ${result.analyzed}<br>
                            Failed: ${result.failed}<br>
                            Skipped (Already Analyzed): ${result.skipped}<br>
                            Success Rate: ${result.success_rate}%<br>
                            Processing Time: ${result.processing_time}<br>
                            Batch Size: ${result.batch_size}
                        </div>
                    `;
                    
                    // Show errors if any
                    if (result.errors && result.errors.length > 0) {
                        alertsContainer.innerHTML += `
                            <h4>‚ö†Ô∏è Issues Encountered:</h4>
                            <div class="alert medium" style="background: #fff3cd;">
                        `;
                        result.errors.slice(0, 5).forEach(error => {
                            alertsContainer.innerHTML += `<small>‚Ä¢ ${error}</small><br>`;
                        });
                        if (result.errors.length > 5) {
                            alertsContainer.innerHTML += `<small>... and ${result.errors.length - 5} more errors</small><br>`;
                        }
                        alertsContainer.innerHTML += `</div>`;
                    }
                    
                    // Check if more articles need analysis
                    if (result.analyzed > 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff;">
                                <strong>üí° Continue Processing?</strong><br>
                                <small>This batch processed ${result.batch_size} articles. More may need analysis.</small><br>
                                <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">üîÑ Analyze Next Batch</button>
                                <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">üìä Check Status</button>
                            </div>
                        `;
                    }
                    
                    // Refresh dashboard data
                    setTimeout(() => {
                        getDatabaseStats();
                    }, 2000);
                    
                } else {
                    const error = data.error || data.analysis_result?.errors?.join(', ') || 'Unknown error occurred';
                    updateStatus(`Analysis failed: ${error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>‚ùå Analysis Failed</strong><br>
                            Error: ${error}<br>
                            <small>Try with a smaller batch or check your OpenAI API key configuration.</small><br>
                            <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">üìä Check Database Status</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in analysis:', error);
                updateStatus('Analysis failed - check console for details', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>‚ùå Network or Processing Error</strong><br>
                        Error: ${error.message}<br>
                        <small>This might be due to timeout, network issues, or server overload.</small><br>
                        <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">üîÑ Try Again</button>
                        <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">üìä Check Status</button>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Analyze Mediaseuranta entries with AI
        async function analyzeMediaseuranta() {
            showLoading(true);
            updateStatus('Analyzing Mediaseuranta entries with AI...', 'warning');
            
            try {
                // Check stats first
                const statsResponse = await fetch('mediaseuranta_analyzer.php?action=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.mediaseuranta_stats) {
                    const stats = statsData.mediaseuranta_stats;
                    const pending = stats.by_status?.pending || 0;
                    
                    if (pending === 0) {
                        updateStatus('All Mediaseuranta entries are already analyzed', 'success');
                        showLoading(false);
                        return;
                    }
                    
                    updateStatus(`Found ${pending} Mediaseuranta entries to analyze...`, 'info');
                }
                
                // Start analysis
                const response = await fetch('mediaseuranta_analyzer.php?action=analyze&batch_size=5');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.mediaseuranta_analysis && data.mediaseuranta_analysis.success) {
                    const result = data.mediaseuranta_analysis;
                    updateStatus(`‚úÖ Mediaseuranta analysis completed! ${result.analyzed} entries analyzed`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>üì∞ Mediaseuranta Analysis Completed</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>‚úÖ Analysis Results:</strong><br>
                            Entries Analyzed: ${result.analyzed}<br>
                            Failed: ${result.failed}<br>
                            Success Rate: ${result.success_rate}%<br>
                            Processing Time: ${result.processing_time}<br>
                            Batch Size: ${result.batch_size}
                        </div>
                    `;
                    
                    // Show continue button if needed
                    if (result.analyzed > 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff;">
                                <strong>üí° Continue Processing?</strong><br>
                                <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">üîÑ Analyze Next Batch</button>
                                <button class="btn" onclick="viewMediaseurantaInsights()" style="margin-top: 10px;">üìä View Insights</button>
                            </div>
                        `;
                    }
                    
                } else {
                    const error = data.error || 'Unknown error occurred';
                    updateStatus(`Mediaseuranta analysis failed: ${error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>‚ùå Analysis Failed</strong><br>
                            Error: ${error}<br>
                            <small>Check database connection and OpenAI API configuration.</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in Mediaseuranta analysis:', error);
                updateStatus('Mediaseuranta analysis failed - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>‚ùå Network Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Check your connection and try again.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // View Mediaseuranta AI insights
        async function viewMediaseurantaInsights() {
            showLoading(true);
            updateStatus('Loading Mediaseuranta AI insights...', 'info');
            
            try {
                const response = await fetch('mediaseuranta_analyzer.php?action=insights&limit=15&min_relevance=5');
                const data = await response.json();
                
                if (data.mediaseuranta_insights) {
                    const insights = data.mediaseuranta_insights;
                    updateStatus(`‚úÖ Loaded ${insights.length} analyzed Mediaseuranta entries`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>üìä Mediaseuranta AI Insights</h4>
                    `;
                    
                    if (insights.length === 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium">
                                <strong>No analyzed entries found</strong><br>
                                <small>Run analysis first to generate insights.</small><br>
                                <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">üì∞ Start Analysis</button>
                            </div>
                        `;
                    } else {
                        insights.slice(0, 10).forEach(entry => {
                            const sectors = entry.ai_key_sectors_parsed ? entry.ai_key_sectors_parsed.slice(0, 3).join(', ') : 'N/A';
                            const keywords = entry.ai_keywords_parsed ? entry.ai_keywords_parsed.slice(0, 5).join(', ') : 'N/A';
                            
                            const alertClass = entry.ai_relevance_score >= 8 ? 'high' : 
                                               entry.ai_relevance_score >= 6 ? 'medium' : 'low';
                            
                            alertsContainer.innerHTML += `
                                <div class="alert ${alertClass}">
                                    <strong>${entry.Maakunta_Nimi} - ${entry.Teema}</strong><br>
                                    <small><strong>Date:</strong> ${entry.uutisen_pvm}</small><br>
                                    <small><strong>News:</strong> ${entry.Uutinen.substring(0, 150)}...</small><br>
                                    <small><strong>Relevance:</strong> ${entry.ai_relevance_score}/10 | 
                                    <strong>Impact:</strong> ${entry.ai_economic_impact} | 
                                    <strong>Sentiment:</strong> ${entry.ai_sentiment}</small><br>
                                    <small><strong>Sectors:</strong> ${sectors}</small><br>
                                    <small><strong>Keywords:</strong> ${keywords}</small><br>
                                    ${entry.ai_summary ? `<small><strong>Summary:</strong> ${entry.ai_summary}</small><br>` : ''}
                                    ${entry.Url ? `<small><a href="${entry.Url}" target="_blank">üîó Read more</a></small>` : ''}
                                </div>
                            `;
                        });
                        
                        if (insights.length > 10) {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <small>Showing 10 of ${insights.length} entries. Use API for complete data.</small>
                                </div>
                            `;
                        }
                    }
                    
                } else {
                    updateStatus('Failed to load Mediaseuranta insights', 'error');
                }
                
            } catch (error) {
                console.error('Error loading insights:', error);
                updateStatus('Failed to load insights - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>‚ùå Failed to Load Insights</strong><br>
                        Error: ${error.message}<br>
                        <small>Check database connection and try again.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            updateStatus('Dashboard ready', 'success');
        });
    </script>
</body>
</html>