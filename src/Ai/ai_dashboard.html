<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Tulevaisuusluotain Dashboard - Hämeen ELY-keskus</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .widget {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .widget h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }
        
        .alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .alert.high {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .alert.medium {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2a5298;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #2a5298;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 8px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        
        .btn:hover {
            background: #1e3c72;
            transform: translateY(-1px);
        }
        
        /* Enhanced tooltip styling */
        .btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: normal;
            max-width: 200px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .btn[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        #status {
            font-weight: bold;
            margin-left: 10px;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🤖 AI Tulevaisuusluotain Dashboard</h1>
        <p>Mediaseuranta analyysi / Hämeen ELY-alue</p>
        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 4px; margin-top: 10px;">
            <small>
                📊 <strong>Data Sources:</strong> YLE Häme, Hämeen Sanomat, STT, ELY-keskus  | 
                🧠 <strong>AI Analyysi:</strong> OpenAI GPT-4 + rule-based fallbacks | 
                🔄 <strong>Päivitykset:</strong> Reaaliaikainen kerääminen ja analyysi
            </small>
        </div>
        <span id="status" class="success">Järjestelmä aktiivinen</span>
    </div>

    <div class="controls">
        <button class="btn" onclick="loadAlerts()" title="Tarkista kriittisiä hälytyksiä ja signaaleja uutisvirrasta, (5 artikkelia kerrallaan)">� Tarkista uudet Hälytykset (OpenAi , limit 5)</button>
        <button class="btn" onclick="loadWeeklyReport()" title="Luo viikkoinen AI-analyysi kerätystä uutismateriaalista">📊 Viikkoraportti</button>
        <button class="btn" onclick="loadCompetitiveIntel()" title="Analysoi kilpailijoiden ja markkinoiden toimintaa">🔍 Kilpailutiedustelu</button>
        <button class="btn" onclick="runAnalysis()" title="Suorita AI-analyysi ja päivitä visualisoinnit">🧠 Suorita AI-analyysi</button>
        <button class="btn" onclick="collectToDatabase()" style="background: #007bff;" title="Kerää uutiset YLE:stä ja tallenna tietokantaan">💾 Kerää Tietokantaan</button>
        <button class="btn" onclick="viewStoredNews()" style="background: #6f42c1;" title="Näytä tietokantaan tallennetut uutiset">📰 Näytä Tallennetut</button>
        <button class="btn" onclick="workingTest()" style="background: #28a745;" title="Testaa uutisten keräystä ilman tietokantaan tallennusta">✅ Toimivuustesti</button>
        <button class="btn" onclick="analyzeStoredArticles()" style="background: #e67e22;" title="Analysoi tallennetut uutiset AI:lla erissä (5 artikkelia kerrallaan)">🤖 Analysoi Artikkeleita (OpenAi, limit 5)</button>
        <button class="btn" onclick="analyzeMediaseuranta()" style="background: #9b59b6;" title="Analysoi Mediaseuranta-taulun sisältö AI:lla (5 artikkelia kerrallaan)">📰 Analysoi Mediaseuranta (OpenAi, limit 5)</button>
        <button class="btn" onclick="viewMediaseurantaInsights()" style="background: #34495e;" title="Näytä Mediaseurannan AI-analyysien tulokset">📊 Mediaseurannan Tulokset</button>
        <button class="btn" onclick="debugMediaseuranta()" style="background: #e74c3c;" title="Testaa Mediaseuranta-taulun yhteyttä ja rakennetta">🔧 Debuggaa Mediaseuranta</button>
        <button class="btn" onclick="testMediaseuranta()" style="background: #f39c12;" title="Testaa datan hakemista Mediaseuranta-taulusta">🧪 Testaa Dataa</button>
        <span class="loading" id="loading">⏳ Processing...</span>
        
        <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
            <strong>ℹ️ Pikaopas:</strong> 
            <strong>💾 Kerää Tietokantaan</strong> = Kerää | 
            <strong>✅ Toimivuustesti</strong> = Testaus ilman tallennusta | 
            Hover buttons for detailed descriptions.
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Reaaliaikaiset Hälytykset -->
        <div class="widget">
            <h3>🚨 Reaaliaikaiset Hälytykset</h3>
            <div id="alerts-container">
                <p>Klikkaa "Tarkista Hälytykset" etsiäksesi kriisisignaaleja...</p>
            </div>
        </div>

        <!-- Uutisten volyymi -->
        <div class="widget">
            <h3>📈 Uutisten volyymi</h3>
            <div class="chart-container">
                <canvas id="volumeChart"></canvas>
            </div>
        </div>

        <!-- Sentimentti-analyysi -->
        <div class="widget">
            <h3>😊 Sentimentti-analyysi</h3>
            <div class="chart-container">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>

        <!-- Teemojen esiintyminen -->
        <div class="widget">
            <h3>🏷️ Teemojen esiintyminen</h3>
            <div class="chart-container">
                <canvas id="themeChart"></canvas>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="widget">
            <h3>📊 Avainluvut (24h)</h3>
            <div id="metrics-container">
                <div class="metric">
                    <span>Artikkeleita prosessoitu</span>
                    <span class="metric-value" id="articles-count">-</span>
                </div>
                <div class="metric">
                    <span>Kriisisignaalit</span>
                    <span class="metric-value" id="crisis-count">-</span>
                </div>
                <div class="metric">
                    <span>Korkean vaikutuksen tapahtumat</span>
                    <span class="metric-value" id="impact-count">-</span>
                </div>
                <div class="metric">
                    <span>Keskimääräiset sentimenttipisteet</span>
                    <span class="metric-value" id="sentiment-avg">-</span>
                </div>
            </div>
        </div>

        <!-- Competitive Intelligence -->
        <div class="widget">
            <h3>🏢 Kilpailija-analyysi</h3>
            <div id="competitive-container">
                <p>Klikkaa "Kilpailija-analyysi" analysoidaksesi markkinatoimintaa...</p>
            </div>
        </div>
    </div>

    <!-- Weekly Report Modal -->
    <div id="report-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
        <div style="background: white; margin: 50px auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80%; overflow-y: auto;">
            <h2>📋 Weekly Intelligence Report</h2>
            <div id="report-content"></div>
            <button class="btn" onclick="closeReport()">Close</button>
        </div>
    </div>

    <script>
        let volumeChart, sentimentChart, themeChart;

        // Initialize charts
        function initCharts() {
            // Volume Chart
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Article Count',
                        data: [],
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Sentiment Chart
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(sentimentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#28a745', '#6c757d', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Theme Chart
            const themeCtx = document.getElementById('themeChart').getContext('2d');
            themeChart = new Chart(themeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Theme Mentions',
                        data: [],
                        backgroundColor: '#2a5298'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Load alerts
        async function loadAlerts() {
            showLoading(true);
            try {
                const response = await fetch('news_intelligence_api.php?action=alerts');
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from alerts API:', text);
                    throw new Error('Server returned HTML error page instead of JSON. Check server logs for details.');
                }
                
                const data = await response.json();
                
                const container = document.getElementById('alerts-container');
                container.innerHTML = '';
                
                // Handle API errors
                if (data.error) {
                    container.innerHTML = `
                        <div class="alert high">
                            <strong>❌ API Virhe:</strong> ${data.error}<br>
                            <small>Tämä voi johtua puuttuvista riippuvuuksista tai konfiguraatio-ongelmista.</small>
                        </div>
                    `;
                    updateStatus('Alerts API error - using fallback', 'warning');
                    
                    // Use fallback mock alerts
                    showMockAlerts(container);
                    return;
                }
                
                // Handle both server response format (direct array) and local development format (object with alerts property)
                let alertsData = data;
                if (data.alerts) {
                    // Local development format - use the alerts array inside the response
                    alertsData = data.alerts;
                }
                
                // Handle local development status message
                if (data.status === 'local_development') {
                    container.innerHTML = `
                        <div class="alert medium">
                            <strong>🏠 Paikallinen Kehitysympäristö</strong><br>
                            ${data.message}<br>
                            <small>Ympäristö: ${data.environment} | Hälytykset: ${data.count} (demo)</small>
                        </div>
                    `;
                }
                
                if (!alertsData || alertsData.length === 0) {
                    container.innerHTML = '<p style="color: #28a745;">✅ Kriittisiä hälytyksiä ei havaittu</p>';
                } else {
                    alertsData.forEach(alert => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert ${alert.severity || 'medium'}`;
                        
                        // Handle different alert formats (server vs demo)
                        let alertContent = `
                            <strong>${(alert.type || '').replace('_', ' ').toUpperCase()}</strong><br>
                            ${alert.title || alert.message || 'Alert'}<br>
                        `;
                        
                        // Add probability if available (server alerts)
                        if (alert.probability !== undefined) {
                            alertContent += `<small>Todennäköisyys: ${(alert.probability * 100).toFixed(1)}%</small>`;
                        }
                        
                        // Add description if available (demo alerts)
                        if (alert.description) {
                            alertContent += `<small>${alert.description}</small>`;
                        }
                        
                        // Add timestamp
                        if (alert.timestamp || alert.detected_at) {
                            alertContent += `<br><small>Aika: ${alert.timestamp || alert.detected_at}</small>`;
                        }
                        
                        alertDiv.innerHTML = alertContent;
                        container.appendChild(alertDiv);
                    });
                }
                
                updateStatus('Hälytykset päivitetty', 'success');
            } catch (error) {
                console.error('Error loading alerts:', error);
                updateStatus('Hälytysten lataus epäonnistui - käytetään varasuunnitelmaa', 'warning');
                
                // Fallback: show mock alerts with Finnish error message
                const container = document.getElementById('alerts-container');
                container.innerHTML = `
                    <div class="alert high">
                        <strong>🚨 API Yhteysvirhe</strong><br>
                        Virhe: ${error.message}<br>
                        <small>news_intelligence_api.php palauttaa 500-virheen. Mahdollisia syitä:</small>
                        <ul style="margin-top: 10px; margin-bottom: 10px;">
                            <li>Puuttuva ai_config.json tiedosto</li>
                            <li>OpenAI API-avain ei konfiguroitu</li>
                            <li>Python-riippuvuudet puuttuvat</li>
                            <li>Tietokantayhteys epäonnistuu</li>
                        </ul>
                        <small><strong>Ratkaisu:</strong> Tarkista palvelimen error_log tai käytä muita toimintoja.</small>
                    </div>
                `;
                
                showMockAlerts(container);
            }
            showLoading(false);
        }
        
        // Show mock alerts as fallback
        function showMockAlerts(container) {
            container.innerHTML += `
                <div class="alert medium" style="background: #e7f3ff; border-color: #0066cc;">
                    <strong>📊 Simuloidut Hälytykset (Varasuunnitelma)</strong><br>
                    Alla on esimerkkihälytyksiä järjestelmän toiminnasta:
                </div>
                <div class="alert medium">
                    <strong>TYÖLLISYYSTILANNE</strong><br>
                    Hämeenlinnan työttömyysaste nousussa<br>
                    <small>Todennäköisyys: 45.2%</small>
                </div>
                <div class="alert low">
                    <strong>KOULUTUS UUTISET</strong><br>
                    Uusi teknologia-ohjelma käynnistyy<br>
                    <small>Todennäköisyys: 23.1%</small>
                </div>
            `;
        }

        // Load weekly report
        async function loadWeeklyReport() {
            showLoading(true);
            try {
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const response = await fetch(`news_intelligence_api.php?action=weekly_report&start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();
                
                document.getElementById('report-content').innerHTML = `
                    <h3>Period: ${data.period.start} to ${data.period.end}</h3>
                    <p><strong>Total Articles Analyzed:</strong> ${data.total_articles_analyzed}</p>
                    <h4>Executive Summary</h4>
                    <pre>${JSON.stringify(data.executive_summary, null, 2)}</pre>
                    <h4>Portfolio Analysis</h4>
                    <pre>${JSON.stringify(data.portfolio_analysis, null, 2)}</pre>
                `;
                
                document.getElementById('report-modal').style.display = 'block';
                updateStatus('Weekly report generated', 'success');
            } catch (error) {
                console.error('Error loading report:', error);
                updateStatus('Failed to generate report', 'error');
            }
            showLoading(false);
        }

        // Load competitive intelligence
        async function loadCompetitiveIntel() {
            showLoading(true);
            try {
                const response = await fetch('news_intelligence_api.php?action=competitive_intelligence&days=30');
                const data = await response.json();
                
                const container = document.getElementById('competitive-container');
                container.innerHTML = `
                    <h4>Companies Activity (30 days)</h4>
                    <div id="companies-list"></div>
                    <h4>Funding Activities</h4>
                    <div id="funding-list"></div>
                `;
                
                const companiesList = document.getElementById('companies-list');
                const companiesData = data.companies_activity || {};
                if (Object.keys(companiesData).length === 0) {
                    companiesList.innerHTML = '<p>No company activities detected</p>';
                } else {
                    Object.entries(companiesData).forEach(([company, count]) => {
                        companiesList.innerHTML += `<div class="metric"><span>${company}</span><span>${count} mentions</span></div>`;
                    });
                }
                
                updateStatus('Competitive intelligence updated', 'success');
            } catch (error) {
                console.error('Error loading competitive intelligence:', error);
                updateStatus('Failed to load competitive intelligence', 'error');
            }
            showLoading(false);
        }

        // Run AI analysis
        async function runAnalysis() {
            showLoading(true);
            updateStatus('Running AI analysis...', 'warning');
            
            try {
                // Simulate analysis with sample data
                setTimeout(() => {
                    // Update charts with sample data
                    updateVolumeChart();
                    updateSentimentChart();
                    updateThemeChart();
                    updateMetrics();
                    
                    updateStatus('AI analysis completed', 'success');
                    showLoading(false);
                }, 2000);
                
            } catch (error) {
                console.error('Error running analysis:', error);
                updateStatus('Analysis failed', 'error');
                showLoading(false);
            }
        }

        // Update chart functions
        function updateVolumeChart() {
            const dates = [];
            const values = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                dates.push(date.toLocaleDateString('fi'));
                values.push(Math.floor(Math.random() * 50) + 10);
            }
            
            volumeChart.data.labels = dates;
            volumeChart.data.datasets[0].data = values;
            volumeChart.update();
        }

        function updateSentimentChart() {
            sentimentChart.data.datasets[0].data = [
                Math.floor(Math.random() * 40) + 30,
                Math.floor(Math.random() * 30) + 20,
                Math.floor(Math.random() * 20) + 10
            ];
            sentimentChart.update();
        }

        function updateThemeChart() {
            const themes = ['Työllisyys', 'Koulutus', 'Teknologia', 'Talous', 'Ympäristö'];
            const values = themes.map(() => Math.floor(Math.random() * 30) + 5);
            
            themeChart.data.labels = themes;
            themeChart.data.datasets[0].data = values;
            themeChart.update();
        }

        function updateMetrics() {
            document.getElementById('articles-count').textContent = Math.floor(Math.random() * 100) + 50;
            document.getElementById('crisis-count').textContent = Math.floor(Math.random() * 5);
            document.getElementById('impact-count').textContent = Math.floor(Math.random() * 10);
            document.getElementById('sentiment-avg').textContent = (Math.random() * 0.4 + 0.3).toFixed(2);
        }

        // Update charts with Mediaseuranta AI analysis data
        function updateChartsWithMediaseurantaData(insights) {
            // Update Volume Chart with entry frequency over time
            updateVolumeChartWithMediaseuranta(insights);
            
            // Update Sentiment Chart with AI sentiment analysis
            updateSentimentChartWithMediaseuranta(insights);
            
            // Update Theme Chart with AI key sectors
            updateThemeChartWithMediaseuranta(insights);
        }

        function updateVolumeChartWithMediaseuranta(insights) {
            // Group entries by date and count frequency
            const dateCount = {};
            insights.forEach(entry => {
                const date = entry.uutisen_pvm ? entry.uutisen_pvm.split(' ')[0] : 'Unknown';
                dateCount[date] = (dateCount[date] || 0) + 1;
            });
            
            // Get dates from last 3 months instead of just 7 days (for Mediaseuranta data)
            const allDates = Object.keys(dateCount).sort();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            
            // Filter dates to last 3 months and take up to 20 most recent dates
            const recentDates = allDates.filter(date => {
                try {
                    const entryDate = new Date(date);
                    return entryDate >= threeMonthsAgo;
                } catch (e) {
                    return false; // Skip invalid dates
                }
            }).slice(-20); // Show max 20 data points for readability
            
            const volumes = recentDates.map(date => dateCount[date] || 0);
            
            // Format dates for display (shorter format for 3 months of data)
            const displayDates = recentDates.map(date => {
                try {
                    const d = new Date(date);
                    return d.toLocaleDateString('fi', { 
                        month: 'short', 
                        day: 'numeric'
                    });
                } catch (e) {
                    return date;
                }
            });
            
            volumeChart.data.labels = displayDates.length > 0 ? displayDates : ['No Data'];
            volumeChart.data.datasets[0].data = volumes.length > 0 ? volumes : [0];
            volumeChart.data.datasets[0].label = 'Mediaseuranta Entries (3 months)';
            volumeChart.update();
        }

        function updateSentimentChartWithMediaseuranta(insights) {
            // Count sentiment distribution from AI analysis
            let positive = 0, neutral = 0, negative = 0;
            
            insights.forEach(entry => {
                const sentiment = (entry.ai_sentiment || '').toLowerCase();
                if (sentiment.includes('positive') || sentiment.includes('myönteinen')) {
                    positive++;
                } else if (sentiment.includes('negative') || sentiment.includes('kielteinen')) {
                    negative++;
                } else {
                    neutral++;
                }
            });
            
            // If no data, show equal distribution
            if (positive + neutral + negative === 0) {
                positive = neutral = negative = 1;
            }
            
            sentimentChart.data.labels = ['Positive', 'Neutral', 'Negative'];
            sentimentChart.data.datasets[0].data = [positive, neutral, negative];
            sentimentChart.update();
        }

        function updateThemeChartWithMediaseuranta(insights) {
            // Count key sectors frequency from AI analysis
            const sectorCount = {};
            
            insights.forEach(entry => {
                if (entry.ai_key_sectors_parsed && Array.isArray(entry.ai_key_sectors_parsed)) {
                    entry.ai_key_sectors_parsed.forEach(sector => {
                        const cleanSector = sector.trim();
                        if (cleanSector) {
                            sectorCount[cleanSector] = (sectorCount[cleanSector] || 0) + 1;
                        }
                    });
                }
            });
            
            // Get top 5 sectors
            const sortedSectors = Object.entries(sectorCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            if (sortedSectors.length > 0) {
                themeChart.data.labels = sortedSectors.map(([sector]) => sector);
                themeChart.data.datasets[0].data = sortedSectors.map(([,count]) => count);
                themeChart.data.datasets[0].label = 'Sector Frequency';
            } else {
                // Fallback data
                themeChart.data.labels = ['No Sector Data'];
                themeChart.data.datasets[0].data = [0];
                themeChart.data.datasets[0].label = 'Sector Frequency';
            }
            
            themeChart.update();
        }

        function updateMetricsWithMediaseurantaData(insights) {
            // Update metrics with real Mediaseuranta data
            document.getElementById('articles-count').textContent = insights.length;
            
            // Count high-impact entries (relevance >= 8)
            const highImpact = insights.filter(entry => entry.ai_relevance_score >= 8).length;
            document.getElementById('impact-count').textContent = highImpact;
            
            // Count crisis-related entries (high relevance + negative sentiment)
            const crisisSignals = insights.filter(entry => 
                entry.ai_relevance_score >= 7 && 
                (entry.ai_sentiment || '').toLowerCase().includes('negative')
            ).length;
            document.getElementById('crisis-count').textContent = crisisSignals;
            
            // Calculate average relevance score
            const avgRelevance = insights.length > 0 
                ? (insights.reduce((sum, entry) => sum + (entry.ai_relevance_score || 0), 0) / insights.length / 10).toFixed(2)
                : '0.00';
            document.getElementById('sentiment-avg').textContent = avgRelevance;
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'inline' : 'none';
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        function closeReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        // Collect news to database
        async function collectToDatabase() {
            showLoading(true);
            updateStatus('Collecting and storing news to database...', 'warning');
            
            try {
                const response = await fetch('database_news_collector.php?action=collect');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.collection_stats;
                    const dbStats = data.database_stats;
                    
                    updateStatus(`✅ Success! Stored ${stats.new_articles_stored} new articles (${stats.hame_relevant_articles} Häme relevant)`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>💾 Database Collection Complete!</h4>
                        
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>📊 Collection Results:</strong><br>
                            • New Articles Stored: ${stats.new_articles_stored}<br>
                            • Häme Relevant: ${stats.hame_relevant_articles}<br>
                            • Duplicates Skipped: ${stats.duplicates_skipped}<br>
                            • Total in Database: ${dbStats.total_articles}
                        </div>
                        
                        <h4>📡 Source Performance:</h4>
                    `;
                    
                    // Show source details
                    Object.entries(stats.source_details).forEach(([source, details]) => {
                        const statusIcon = details.status === 'success' ? '✅' : '❌';
                        const alertClass = details.status === 'success' ? 'medium' : 'high';
                        
                        alertsContainer.innerHTML += `
                            <div class="alert ${alertClass}">
                                ${statusIcon} <strong>${source}</strong><br>
                                ${details.status === 'success' ? 
                                    `Found: ${details.articles_found} | Stored: ${details.new_stored} | Häme: ${details.hame_relevant}` : 
                                    `Error: ${details.error}`
                                }
                            </div>
                        `;
                    });
                    
                    // Show database stats
                    if (dbStats.by_source && Object.keys(dbStats.by_source).length > 0) {
                        alertsContainer.innerHTML += '<h4>📈 Database Statistics:</h4>';
                        Object.entries(dbStats.by_source).forEach(([source, count]) => {
                            alertsContainer.innerHTML += `
                                <div class="metric">
                                    <span>${source}</span>
                                    <span class="metric-value">${count}</span>
                                </div>
                            `;
                        });
                    }
                    
                    alertsContainer.innerHTML += `
                        <div class="alert" style="background: #e8f5e8; border-color: #28a745; margin-top: 15px;">
                            <strong>🎉 Database Collection Working!</strong><br>
                            • Articles ready for AI analysis<br>
                            • Historical data building up<br>
                            • Ready for trend analysis<br>
                            <button class="btn" onclick="viewStoredNews()" style="margin-top: 10px;">📋 View Stored Articles</button>
                        </div>
                    `;
                    
                    // Auto-refresh metrics
                    setTimeout(() => {
                        updateMetrics();
                    }, 2000);
                    
                } else {
                    updateStatus(`Database collection failed: ${data.error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Database Collection Failed</strong><br>
                            Error: ${data.error}<br>
                            <p>Possible solutions:</p>
                            <ul>
                                <li>Check if news_articles table exists</li>
                                <li>Verify database permissions</li>
                                <li>Run create_news_tables.sql if needed</li>
                            </ul>
                            <button class="btn" onclick="workingTest()" style="margin-top: 10px;">✅ Kokeile Toimivuustestiä</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in database collection:', error);
                updateStatus('Database collection failed - check console', 'error');
            }
            showLoading(false);
        }

        // View stored news from database
        async function viewStoredNews() {
            showLoading(true);
            updateStatus('Loading stored news from database...', 'warning');
            
            try {
                const response = await fetch('database_news_collector.php?action=recent&limit=10');
                const data = await response.json();
                
                updateStatus(`📋 Loaded ${data.count} recent articles from database`, 'success');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '<h4>📋 Recent Articles from Database:</h4>';
                
                if (data.recent_articles && data.recent_articles.length > 0) {
                    data.recent_articles.forEach((article, index) => {
                        const relevanceData = article.region_relevance ? JSON.parse(article.region_relevance) : {};
                        const relevanceIcon = relevanceData.is_relevant ? '🎯' : '📰';
                        
                        alertsContainer.innerHTML += `
                            <div class="alert medium">
                                ${relevanceIcon} <strong>${article.title}</strong><br>
                                <small>${article.content}</small><br>
                                <small>
                                    Source: ${article.source} | 
                                    Published: ${article.published_date} | 
                                    Collected: ${article.collected_at}
                                    ${relevanceData.keywords ? ' | Keywords: ' + relevanceData.keywords.join(', ') : ''}
                                </small>
                            </div>
                        `;
                    });
                    
                    alertsContainer.innerHTML += `
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="collectToDatabase()">💾 Collect More News</button>
                            <button class="btn" onclick="getDatabaseStats()">📊 View Statistics</button>
                        </div>
                    `;
                } else {
                    alertsContainer.innerHTML += `
                        <div class="alert medium">
                            No articles found in database yet.<br>
                            <button class="btn" onclick="collectToDatabase()" style="margin-top: 10px;">💾 Start Collecting</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error viewing stored news:', error);
                updateStatus('Failed to load stored news', 'error');
            }
            showLoading(false);
        }

        // Get database statistics
        async function getDatabaseStats() {
            try {
                const response = await fetch('database_news_collector.php?action=stats');
                const data = await response.json();
                
                if (data.database_stats) {
                    const stats = data.database_stats;
                    
                    // Update metrics display
                    document.getElementById('articles-count').textContent = stats.total_articles || 0;
                    document.getElementById('crisis-count').textContent = '0'; // Will be calculated later
                    document.getElementById('impact-count').textContent = stats.pending_analysis || 0;
                    document.getElementById('sentiment-avg').textContent = '0.65'; // Sample
                    
                    updateStatus(`📊 Database stats updated: ${stats.total_articles} articles total`, 'success');
                }
            } catch (error) {
                console.error('Error getting database stats:', error);
            }
        }

        // Update metrics from database
        function updateMetrics() {
            getDatabaseStats();
        }

        // Working test with fixed RSS URLs
        async function workingTest() {
            showLoading(true);
            updateStatus('Testing with corrected RSS URLs...', 'warning');
            
            try {
                const response = await fetch('news_working_test.php?action=real_news');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(`✅ REAL NEWS COLLECTION WORKING! ${data.total_articles} articles found`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🎉 SUCCESS! Real News Collection Working!</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>✅ Network Issue Solved!</strong><br>
                            Total Articles: ${data.total_articles}<br>
                            Häme Relevant: ${data.hame_relevant}<br>
                            Method: ${data.method}
                        </div>
                    `;
                    
                    // Show source results
                    if (data.source_results) {
                        alertsContainer.innerHTML += '<h4>📡 RSS Source Status:</h4>';
                        Object.entries(data.source_results).forEach(([source, result]) => {
                            const statusIcon = result.status === 'success' ? '✅' : '❌';
                            const alertClass = result.status === 'success' ? 'medium' : 'high';
                            alertsContainer.innerHTML += `
                                <div class="alert ${alertClass}">
                                    ${statusIcon} <strong>${source}</strong><br>
                                    Status: ${result.status}<br>
                                    ${result.articles_found !== undefined ? `Articles: ${result.articles_found}` : ''}
                                    ${result.error ? `Error: ${result.error}` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    // Show Häme-relevant articles
                    if (data.hame_articles && data.hame_articles.length > 0) {
                        alertsContainer.innerHTML += '<h4>🎯 Häme Region News:</h4>';
                        data.hame_articles.forEach(article => {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <strong>${article.title}</strong><br>
                                    <small>${article.description}</small><br>
                                    <small>Keywords: ${article.matched_keywords.join(', ')}</small><br>
                                    <small>Source: ${article.source} | ${article.pub_date}</small>
                                </div>
                            `;
                        });
                    }
                    
                    // Automatically start full system test
                    setTimeout(() => {
                        runAnalysis();
                    }, 2000);
                    
                } else {
                    updateStatus(`Working test failed: ${data.error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Still Having Issues</strong><br>
                            Error: ${data.error}<br>
                            <button class="btn" onclick="mockTest()" style="margin-top: 10px;">📋 Use Mock Data Instead</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in working test:', error);
                updateStatus('Working test failed - trying mock data', 'warning');
                setTimeout(() => mockTest(), 1000);
            }
            showLoading(false);
        }

        async function analyzeStoredArticles() {
            showLoading(true);
            updateStatus('Analyzing stored articles with AI (batch processing)...', 'warning');
            
            try {
                // First, check how many articles need analysis
                const statsResponse = await fetch('database_news_collector.php?action=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.database_stats && statsData.database_stats.pending_analysis > 0) {
                    updateStatus(`Found ${statsData.database_stats.pending_analysis} articles to analyze...`, 'info');
                } else {
                    updateStatus('No articles need analysis', 'success');
                    showLoading(false);
                    return;
                }
                
                // Start analysis with small batch size for reliability
                const response = await fetch('database_news_collector.php?action=analyze&batch_size=5', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }
                
                const data = await response.json();
                
                if (data.analysis_result && data.analysis_result.success) {
                    const result = data.analysis_result;
                    updateStatus(`✅ Batch completed! ${result.analyzed} articles analyzed`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🤖 AI Analysis Batch Completed</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>✅ Batch Results:</strong><br>
                            Articles Analyzed: ${result.analyzed}<br>
                            Failed: ${result.failed}<br>
                            Skipped (Already Analyzed): ${result.skipped}<br>
                            Success Rate: ${result.success_rate}%<br>
                            Processing Time: ${result.processing_time}<br>
                            Batch Size: ${result.batch_size}
                        </div>
                    `;
                    
                    // Show errors if any
                    if (result.errors && result.errors.length > 0) {
                        alertsContainer.innerHTML += `
                            <h4>⚠️ Issues Encountered:</h4>
                            <div class="alert medium" style="background: #fff3cd;">
                        `;
                        result.errors.slice(0, 5).forEach(error => {
                            alertsContainer.innerHTML += `<small>• ${error}</small><br>`;
                        });
                        if (result.errors.length > 5) {
                            alertsContainer.innerHTML += `<small>... and ${result.errors.length - 5} more errors</small><br>`;
                        }
                        alertsContainer.innerHTML += `</div>`;
                    }
                    
                    // Check if more articles need analysis
                    if (result.analyzed > 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff;">
                                <strong>💡 Continue Processing?</strong><br>
                                <small>This batch processed ${result.batch_size} articles. More may need analysis.</small><br>
                                <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">🔄 Analyze Next Batch</button>
                                <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">📊 Check Status</button>
                            </div>
                        `;
                    }
                    
                    // Refresh dashboard data
                    setTimeout(() => {
                        getDatabaseStats();
                    }, 2000);
                    
                } else {
                    const error = data.error || data.analysis_result?.errors?.join(', ') || 'Unknown error occurred';
                    updateStatus(`Analysis failed: ${error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Analysis Failed</strong><br>
                            Error: ${error}<br>
                            <small>Try with a smaller batch or check your OpenAI API key configuration.</small><br>
                            <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">📊 Check Database Status</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in analysis:', error);
                updateStatus('Analysis failed - check console for details', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Network or Processing Error</strong><br>
                        Error: ${error.message}<br>
                        <small>This might be due to timeout, network issues, or server overload.</small><br>
                        <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">🔄 Try Again</button>
                        <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">📊 Check Status</button>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Analyze Mediaseuranta entries with AI
        async function analyzeMediaseuranta() {
            showLoading(true);
            updateStatus('Analyzing Mediaseuranta entries with AI...', 'warning');
            
            try {
                // Check stats first
                const statsResponse = await fetch('mediaseuranta_analyzer.php?action=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.mediaseuranta_stats) {
                    const stats = statsData.mediaseuranta_stats;
                    const pending = stats.by_status?.pending || 0;
                    
                    if (pending === 0) {
                        updateStatus('All Mediaseuranta entries are already analyzed', 'success');
                        showLoading(false);
                        return;
                    }
                    
                    updateStatus(`Found ${pending} Mediaseuranta entries to analyze...`, 'info');
                }
                
                // Start analysis
                const response = await fetch('mediaseuranta_analyzer.php?action=analyze&batch_size=5');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.mediaseuranta_analysis && data.mediaseuranta_analysis.success) {
                    const result = data.mediaseuranta_analysis;
                    updateStatus(`✅ Mediaseuranta analysis completed! ${result.analyzed} entries analyzed`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>📰 Mediaseuranta Analysis Completed</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>✅ Analysis Results:</strong><br>
                            Entries Analyzed: ${result.analyzed}<br>
                            Failed: ${result.failed}<br>
                            Success Rate: ${result.success_rate}%<br>
                            Processing Time: ${result.processing_time}<br>
                            Batch Size: ${result.batch_size}
                        </div>
                    `;
                    
                    // Show continue button if needed
                    if (result.analyzed > 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff;">
                                <strong>💡 Continue Processing?</strong><br>
                                <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">🔄 Analyze Next Batch</button>
                                <button class="btn" onclick="viewMediaseurantaInsights()" style="margin-top: 10px;">📊 View Insights</button>
                            </div>
                        `;
                    }
                    
                } else {
                    const error = data.error || 'Unknown error occurred';
                    updateStatus(`Mediaseuranta analysis failed: ${error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Analysis Failed</strong><br>
                            Error: ${error}<br>
                            <small>Check database connection and OpenAI API configuration.</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in Mediaseuranta analysis:', error);
                updateStatus('Mediaseuranta analysis failed - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Network Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Check your connection and try again.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // View Mediaseuranta AI insights
        async function viewMediaseurantaInsights() {
            showLoading(true);
            updateStatus('Loading Mediaseuranta AI insights...', 'info');
            
            try {
                const response = await fetch('mediaseuranta_analyzer.php?action=insights&limit=100&min_relevance=3');
                const data = await response.json();
                
                if (data.mediaseuranta_insights) {
                    const insights = data.mediaseuranta_insights;
                    updateStatus(`✅ Loaded ${insights.length} analyzed Mediaseuranta entries`, 'success');
                    
                    // Update charts with Mediaseuranta data
                    updateChartsWithMediaseurantaData(insights);
                    updateMetricsWithMediaseurantaData(insights);
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>📊 Mediaseuranta AI Insights</h4>
                    `;
                    
                    if (insights.length === 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium">
                                <strong>No analyzed entries found</strong><br>
                                <small>Run analysis first to generate insights.</small><br>
                                <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">📰 Start Analysis</button>
                            </div>
                        `;
                    } else {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff; border-color: #0066cc;">
                                <strong>📈 Kaaviot Päivitetty!</strong><br>
                                Kaaviot näyttävät nyt Mediaseurannan AI-analyysidatan: tunnelmajakauma, toimialafrekvenssi ja alueelliset trendit.<br>
                                <small>Tieto ${insights.length} analysoidusta merkinnästä, relevanssi ≥3</small>
                            </div>
                        `;
                        
                        insights.slice(0, 10).forEach(entry => {
                            const sectors = entry.ai_key_sectors_parsed ? entry.ai_key_sectors_parsed.slice(0, 3).join(', ') : 'N/A';
                            const keywords = entry.ai_keywords_parsed ? entry.ai_keywords_parsed.slice(0, 5).join(', ') : 'N/A';
                            
                            const alertClass = entry.ai_relevance_score >= 8 ? 'high' : 
                                               entry.ai_relevance_score >= 6 ? 'medium' : 'low';
                            
                            alertsContainer.innerHTML += `
                                <div class="alert ${alertClass}">
                                    <strong>${entry.Maakunta_Nimi} - ${entry.Teema}</strong><br>
                                    <small><strong>Date:</strong> ${entry.uutisen_pvm}</small><br>
                                    <small><strong>News:</strong> ${entry.Uutinen.substring(0, 150)}...</small><br>
                                    <small><strong>Relevance:</strong> ${entry.ai_relevance_score}/10 | 
                                    <strong>Impact:</strong> ${entry.ai_economic_impact} | 
                                    <strong>Sentiment:</strong> ${entry.ai_sentiment}</small><br>
                                    <small><strong>Sectors:</strong> ${sectors}</small><br>
                                    <small><strong>Keywords:</strong> ${keywords}</small><br>
                                    ${entry.ai_summary ? `<small><strong>Summary:</strong> ${entry.ai_summary}</small><br>` : ''}
                                    ${entry.Url ? `<small><a href="${entry.Url}" target="_blank">🔗 Read more</a></small>` : ''}
                                </div>
                            `;
                        });
                        
                        if (insights.length > 10) {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <small>Showing 10 of ${insights.length} entries. Use API for complete data.</small>
                                </div>
                            `;
                        }
                    }
                    
                } else {
                    updateStatus('Failed to load Mediaseuranta insights', 'error');
                }
                
            } catch (error) {
                console.error('Error loading insights:', error);
                updateStatus('Failed to load insights - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Failed to Load Insights</strong><br>
                        Error: ${error.message}<br>
                        <small>Check database connection and try again.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Debug Mediaseuranta connection and structure
        async function debugMediaseuranta() {
            showLoading(true);
            updateStatus('Checking Mediaseuranta database structure...', 'info');
            
            try {
                const response = await fetch('mediaseuranta_analyzer.php?action=debug');
                const data = await response.json();
                
                if (data.debug_info) {
                    const info = data.debug_info;
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🔧 Mediaseuranta Debug Information</h4>
                    `;
                    
                    if (info.error) {
                        alertsContainer.innerHTML += `
                            <div class="alert high">
                                <strong>❌ Error:</strong> ${info.error}<br>
                                <small>This is likely the cause of the 500 error.</small>
                            </div>
                        `;
                        updateStatus('Debug found error - check results', 'error');
                    } else {
                        // Database connection
                        alertsContainer.innerHTML += `
                            <div class="alert ${info.database_connection === 'OK' ? 'medium' : 'high'}">
                                <strong>Database Connection:</strong> ${info.database_connection}<br>
                                <strong>Table Exists:</strong> ${info.table_exists ? 'Yes' : 'No'}<br>
                                <strong>Total Entries:</strong> ${info.total_entries || 'N/A'}
                            </div>
                        `;
                        
                        // AI columns check
                        const aiColumnsHtml = Object.entries(info.ai_columns_exist || {})
                            .map(([col, exists]) => `${col}: ${exists ? '✅' : '❌'}`)
                            .join('<br>');
                        
                        const allAiColumnsExist = Object.values(info.ai_columns_exist || {}).every(exists => exists);
                        
                        alertsContainer.innerHTML += `
                            <div class="alert ${allAiColumnsExist ? 'medium' : 'high'}">
                                <strong>AI Columns Status:</strong><br>
                                ${aiColumnsHtml}<br>
                                ${!allAiColumnsExist ? '<br><strong>⚠️ Missing AI columns! Run the SQL script first.</strong>' : ''}
                            </div>
                        `;
                        
                        // Show all columns for reference
                        if (info.columns && info.columns.length > 0) {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <strong>All Table Columns:</strong><br>
                                    <small>${info.columns.join(', ')}</small>
                                </div>
                            `;
                        }
                        
                        // Recommendations
                        if (!info.table_exists) {
                            alertsContainer.innerHTML += `
                                <div class="alert high">
                                    <strong>🚨 Action Required:</strong><br>
                                    Mediaseuranta table not found. Check database name and connection.
                                </div>
                            `;
                        } else if (!allAiColumnsExist) {
                            alertsContainer.innerHTML += `
                                <div class="alert high">
                                    <strong>🚨 Action Required:</strong><br>
                                    Run the SQL script: add_mediaseuranta_ai_columns.sql<br>
                                    This will add the missing AI analysis columns to your table.
                                </div>
                            `;
                        } else {
                            alertsContainer.innerHTML += `
                                <div class="alert medium" style="background: #d4edda;">
                                    <strong>✅ Everything looks good!</strong><br>
                                    You can now try running the analysis.
                                </div>
                            `;
                        }
                        
                        updateStatus('Debug completed successfully', 'success');
                    }
                } else {
                    updateStatus('Debug failed to return information', 'error');
                }
                
            } catch (error) {
                console.error('Error in debug:', error);
                updateStatus('Debug failed - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Debug Error</strong><br>
                        Error: ${error.message}<br>
                        <small>This might be the cause of the 500 error.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Test basic data retrieval from Mediaseuranta
        async function testMediaseuranta() {
            showLoading(true);
            updateStatus('Testing data retrieval from Mediaseuranta...', 'info');
            
            try {
                const response = await fetch('mediaseuranta_analyzer.php?action=test');
                const data = await response.json();
                
                if (data.test_result) {
                    const result = data.test_result;
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🧪 Mediaseuranta Data Test Results</h4>
                    `;
                    
                    if (result.error) {
                        alertsContainer.innerHTML += `
                            <div class="alert high">
                                <strong>❌ Test Failed:</strong> ${result.error}<br>
                                <small>This indicates the specific problem with data access.</small>
                            </div>
                        `;
                        updateStatus('Data test failed - see error above', 'error');
                    } else {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #d4edda;">
                                <strong>✅ Data Access Working!</strong><br>
                                Connection: ${result.connection}<br>
                                Unanalyzed Entries Found: ${result.entries_found}
                            </div>
                        `;
                        
                        if (result.sample_entries && result.sample_entries.length > 0) {
                            alertsContainer.innerHTML += `<h4>📄 Sample Entries:</h4>`;
                            
                            result.sample_entries.forEach(entry => {
                                alertsContainer.innerHTML += `
                                    <div class="alert medium">
                                        <strong>Region ${entry.Maakunta_ID}:</strong> ${entry.Teema}<br>
                                        <strong>Date:</strong> ${entry.uutisen_pvm}<br>
                                        <strong>Status:</strong> ${entry.ai_status || 'pending'}<br>
                                        <small>${entry.Uutinen_preview}</small>
                                    </div>
                                `;
                            });
                            
                            if (result.entries_found > 0) {
                                alertsContainer.innerHTML += `
                                    <div class="alert medium" style="background: #e7f3ff;">
                                        <strong>🎉 Ready for Analysis!</strong><br>
                                        Found ${result.entries_found} entries ready to analyze.<br>
                                        <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">📰 Start AI Analysis</button>
                                    </div>
                                `;
                            } else {
                                alertsContainer.innerHTML += `
                                    <div class="alert medium">
                                        <strong>ℹ️ All entries already analyzed</strong><br>
                                        <button class="btn" onclick="viewMediaseurantaInsights()" style="margin-top: 10px;">📊 View Results</button>
                                    </div>
                                `;
                            }
                        }
                        
                        updateStatus(`Data test successful - found ${result.entries_found} entries`, 'success');
                    }
                } else {
                    updateStatus('Test returned invalid response', 'error');
                }
                
            } catch (error) {
                console.error('Error in test:', error);
                updateStatus('Test failed - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Test Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Check network connection and server status.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            updateStatus('Dashboard ready', 'success');
        });
    </script>
</body>
</html>
