<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Tulevaisuusluotain Dashboard - Hämeen ELY-keskus</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .widget {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .widget h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }
        
        .alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .alert.high {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .alert.medium {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2a5298;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #2a5298;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 8px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        
        .btn:hover {
            background: #1e3c72;
            transform: translateY(-1px);
        }
        
        /* Enhanced tooltip styling */
        .btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: normal;
            max-width: 200px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .btn[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        #status {
            font-weight: bold;
            margin-left: 10px;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🤖 AI Tulevaisuusluotain Dashboard</h1>
        <p>Mediaseuranta analyysi / Hämeen ELY-alue</p>
        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 4px; margin-top: 10px;">
            <small>
                📊 <strong>Data Sources:</strong> YLE Häme, Hämeen Sanomat, STT, ELY-keskus  | 
                🧠 <strong>AI Analyysi:</strong> OpenAI GPT-4 + rule-based fallbacks | 
                🔄 <strong>Päivitykset:</strong> Reaaliaikainen kerääminen ja analyysi
            </small>
        </div>
        <span id="status" class="success">Järjestelmä aktiivinen</span>
    </div>

    <div class="controls">
        <p>Ulkoiset tietolähteet</p><br>

        <button class="btn" onclick="analyzeStoredArticles()" style="background: #e67e22;" title="Analysoi tallennettuja uutisia OpenAi:lla (1 artikkeli kerrallaan)">🤖 Analysoi Artikkeleita (OpenAi, limit 1)</button>         
        <button class="btn" onclick="loadAlerts()" title="Analysoi tallennettuja uutisia OpenAi:lla + kriittiset signaalit (1 artikkeli kerrallaan)">🔍 Analysoi artikkeleita + kriittiset signaalit (OpenAi, limit 1)</button>       
        <button class="btn" onclick="collectToDatabase()" style="background: #007bff;" title="Kerää uutisia lähteistä ja tallenna tietokantaan (ei OpenAI-kutsuja)">💾 Kerää uutisia (tietokantaan)</button>        
        <button class="btn" onclick="loadWeeklyReport()" title="Luo Kuukausiraportti jo analysoidusta datasta (ei OpenAI-kutsuja)">📊 Kuukausiraportti (tietokannasta)</button>
        <button class="btn" onclick="loadCompetitiveIntel()" title="Analysoi uutisesta kilpailijoiden ja markkinoiden toimintaa (OpenAI, limit 1)">🔍 Kilpailuanalyysi (OpenAI, limit 1)</button>

        <button class="btn" onclick="viewStoredNews()" style="background: #6f42c1;" title="Näytä tietokantaan tallennetut uutiset">📰 Näytä Tallennetut</button>
        <button class="btn" onclick="workingTest()" style="background: #28a745;" title="Testaa uutisten keräystä ilman tietokantaan tallennusta">✅ Testaus ilman tallennusta</button>
        <br><p>Ely-mediaseuranta</p><br>
        <button class="btn" onclick="analyzeMediaseuranta()" style="background: #9b59b6;" title="Analysoi Mediaseuranta-taulun sisältöä (OpenAI, limit 1)">📰 Analysoi Mediaseuranta (OpenAi, limit 1)</button>
        <button class="btn" onclick="loadMediaseurantaIntelligence()" title="Analysoi Mediaseuranta-dataa ja luo yhteenvetoja (OpenAI, limit 1)" style="background: #8e44ad;">📊 Mediaseuranta Insights (OpenAI, limit 1)</button>
        <button class="btn" onclick="loadMediaseurantaCompetitive()" style="background: #e74c3c;" title="Kilpailutiedustelu Mediaseuranta-datasta (OpenAI, limit 1)" style="background: #2c3e50;">🏢 Mediaseuranta Kilpailuanalyysi (OpenAI, limit 1)</button>        
        <button class="btn" onclick="viewMediaseurantaInsights()" style="background: #f39c12;" title="Näytä Mediaseurannan AI-analyysien tulokset">📊 Mediaseurannan Tulokset</button>
        <!-- <button class="btn" onclick="debugMediaseuranta()" style="background: #e74c3c;" title="Testaa Mediaseuranta-taulun yhteyttä ja rakennetta">🔧 Debuggaa Mediaseuranta</button> -->
        <!-- <button class="btn" onclick="testMediaseuranta()" style="background: #f39c12;" title="Testaa datan hakemista Mediaseuranta-taulusta">🧪 Testaa yhteys kantaan</button> -->
        <span class="loading" id="loading">⏳ Processing...</span>
        
        <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
            <strong>ℹ️ Pikaopas:</strong> 
            <strong>💾 Kerää Tietokantaan</strong> = Kerää | 
            <strong>✅ Toimivuustesti</strong> = Testaus ilman tallennusta | 
            Hover buttons for detailed descriptions.
        </div>
    </div>

    <div class="dashboard-grid" style="display: grid; grid-template-columns: 2fr 3fr; gap: 20px; align-items: start;">
        <!-- Left Column: Alerts -->
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <!-- Reaaliaikaiset Hälytykset -->
            <div class="widget">
                <h3>🚨 Reaaliaikaiset Hälytykset</h3>
                <div id="alerts-container">
                    <p>Klikkaa "Tarkista Hälytykset" etsiäksesi kriisisignaaleja...</p>
                </div>
            </div>

            <!-- Competitive Intelligence -->
            <div class="widget">
                <h3>🏢 Kilpailija-analyysi</h3>
                <div id="competitive-container">
                    <p>Klikkaa "Kilpailija-analyysi" analysoidaksesi markkinatoimintaa...</p>
                </div>
            </div>

            <!-- Mediaseuranta Intelligence -->
            <div class="widget">
                <h3>📰 Mediaseuranta Insights</h3>
                <div id="mediaseuranta-container">
                    <p>Klikkaa "Mediaseuranta Insights" analysoidaksesi mediaseurantatietoja...</p>
                </div>
            </div>

            <!-- Mediaseuranta Competitive Intelligence -->
            <div class="widget">
                <h3>🏢 Mediaseuranta Kilpailuanalyysi</h3>
                <div id="mediaseuranta-competitive-container">
                    <p>Klikkaa "Mediaseuranta Kilpailuanalyysi" kilpailutiedustelua varten...</p>
                </div>
            </div>
        </div>

        <!-- Right Column: Charts and Metrics -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Uutisten volyymi -->
            <div class="widget">
                <h3>📈 Uutisten volyymi</h3>
                <div class="chart-container">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Sentimentti-analyysi -->
            <div class="widget">
                <h3>😊 Sentimentti-analyysi</h3>
                <div class="chart-container">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>

            <!-- Teemojen esiintyminen -->
            <div class="widget">
                <h3>🏷️ Teemojen esiintyminen</h3>
                <div class="chart-container">
                    <canvas id="themeChart"></canvas>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="widget">
                <h3>📊 Avainluvut (24h)</h3>
                <div id="metrics-container">
                    <div class="metric">
                        <span>Artikkeleita prosessoitu</span>
                        <span class="metric-value" id="articles-count">-</span>
                    </div>
                    <div class="metric">
                        <span>Kriisisignaalit</span>
                        <span class="metric-value" id="crisis-count">-</span>
                    </div>
                    <div class="metric">
                        <span>Korkean vaikutuksen tapahtumat</span>
                        <span class="metric-value" id="impact-count">-</span>
                    </div>
                    <div class="metric">
                        <span>Keskimääräiset sentimenttipisteet</span>
                        <span class="metric-value" id="sentiment-avg">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Report Modal -->
    <div id="report-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
        <div style="background: white; margin: 50px auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80%; overflow-y: auto;">
            <h2>📋 Kuukausiraportti - Intelligence Report</h2>
            <div id="report-content"></div>
            <button class="btn" onclick="closeReport()">Close</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // Configuration will be loaded dynamically from PHP endpoint
        let OPENAI_ANALYSIS_LIMIT = 1; // Default fallback, will be overridden
        let CONFIG = {
            openai_analysis_limit: 1,
            cost_protection_message: 'Loading configuration...',
            development_status_message: 'Loading...',
            source: 'fallback'
        };
        
        let volumeChart, sentimentChart, themeChart;

        // Load configuration from PHP endpoint (single source of truth)
        async function loadConfiguration() {
            try {
                const response = await fetch('config_endpoint.php');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const config = await response.json();
                
                // Handle error response
                if (config.error) {
                    console.warn('Configuration error:', config.message);
                    CONFIG = config.fallback_config;
                    OPENAI_ANALYSIS_LIMIT = CONFIG.openai_analysis_limit;
                    updateStatus('⚠️ Using fallback configuration due to error', 'warning');
                    return;
                }
                
                // Update global configuration
                CONFIG = config;
                OPENAI_ANALYSIS_LIMIT = config.openai_analysis_limit;
                
                // Update status to show configuration loaded
                const envType = config.meta ? config.meta.environment : 
                               (OPENAI_ANALYSIS_LIMIT === 1 ? 'development' : 'production');
                
                updateStatus(`⚙️ Configuration loaded: ${envType} mode (limit: ${OPENAI_ANALYSIS_LIMIT})`, 'success');
                
                console.log('Configuration loaded from PHP:', {
                    source: config.source,
                    limit: OPENAI_ANALYSIS_LIMIT,
                    environment: envType,
                    message: config.development_status_message
                });
                
            } catch (error) {
                console.error('Failed to load configuration:', error);
                updateStatus('❌ Configuration load failed - using fallback', 'error');
                
                // Use safe fallback
                OPENAI_ANALYSIS_LIMIT = 1;
                CONFIG = {
                    openai_analysis_limit: 1,
                    cost_protection_message: 'Fallback: max 1 article',
                    development_status_message: '🔧 FALLBACK MODE: 1 article limit',
                    source: 'javascript_fallback'
                };
            }
        }

        // Initialize charts
        function initCharts() {
            // Volume Chart
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Article Count',
                        data: [],
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Sentiment Chart
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(sentimentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#28a745', '#6c757d', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Theme Chart
            const themeCtx = document.getElementById('themeChart').getContext('2d');
            themeChart = new Chart(themeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Theme Mentions',
                        data: [],
                        backgroundColor: '#2a5298'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Load alerts
        async function loadAlerts() {
            showLoading(true);
            try {
                const response = await fetch('minimal_news_api.php?action=alerts');
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from alerts API:', text);
                    throw new Error('Server returned HTML error page instead of JSON. Check server logs for details.');
                }
                
                const data = await response.json();
                
                const container = document.getElementById('alerts-container');
                container.innerHTML = '';
                
                // Handle API errors
                if (data.error) {
                    container.innerHTML = `
                        <div class="alert high">
                            <strong>❌ API Virhe:</strong> ${data.error}<br>
                            <small>Tämä voi johtua puuttuvista riippuvuuksista tai konfiguraatio-ongelmista.</small>
                        </div>
                    `;
                    updateStatus('Alerts API error - using fallback', 'warning');
                    
                    // Use fallback mock alerts
                    showMockAlerts(container);
                    return;
                }
                
                // Handle both server response format (direct array) and local development format (object with alerts property)
                let alertsData = data;
                if (data.alerts) {
                    // Local development format - use the alerts array inside the response
                    alertsData = data.alerts;
                }
                
                // Handle local development status message
                if (data.status === 'local_development') {
                    container.innerHTML = `
                        <div class="alert medium">
                            <strong>🏠 Paikallinen Kehitysympäristö</strong><br>
                            ${data.message}<br>
                            <small>Ympäristö: ${data.environment} | Hälytykset: ${data.count} (demo)</small>
                        </div>
                    `;
                }
                
                if (!alertsData || alertsData.length === 0) {
                    container.innerHTML = '<p style="color: #28a745;">✅ Kriittisiä hälytyksiä ei havaittu</p>';
                } else {
                    alertsData.forEach(alert => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert ${alert.severity || 'medium'}`;
                        
                        // Handle different alert formats (server vs demo)
                        let alertContent = `
                            <strong>${(alert.type || '').replace('_', ' ').toUpperCase()}</strong><br>
                            ${alert.title || alert.message || 'Alert'}<br>
                        `;
                        
                        // Add probability if available (server alerts)
                        if (alert.probability !== undefined) {
                            alertContent += `<small>Todennäköisyys: ${(alert.probability * 100).toFixed(1)}%</small>`;
                        }
                        
                        // Add description if available (demo alerts)
                        if (alert.description) {
                            alertContent += `<small>${alert.description}</small>`;
                        }
                        
                        // Add timestamp
                        if (alert.timestamp || alert.detected_at) {
                            alertContent += `<br><small>Aika: ${alert.timestamp || alert.detected_at}</small>`;
                        }
                        
                        alertDiv.innerHTML = alertContent;
                        container.appendChild(alertDiv);
                    });
                }
                
                updateStatus('Hälytykset päivitetty', 'success');
            } catch (error) {
                console.error('Error loading alerts:', error);
                updateStatus('Hälytysten lataus epäonnistui - käytetään varasuunnitelmaa', 'warning');
                
                // Fallback: show mock alerts with Finnish error message
                const container = document.getElementById('alerts-container');
                container.innerHTML = `
                    <div class="alert high">
                        <strong>🚨 API Yhteysvirhe</strong><br>
                        Virhe: ${error.message}<br>
                        <small>news_intelligence_api.php palauttaa 500-virheen. Mahdollisia syitä:</small>
                        <ul style="margin-top: 10px; margin-bottom: 10px;">
                            <li>Puuttuva ai_config.json tiedosto</li>
                            <li>OpenAI API-avain ei konfiguroitu</li>
                            <li>Python-riippuvuudet puuttuvat</li>
                            <li>Tietokantayhteys epäonnistuu</li>
                        </ul>
                        <small><strong>Ratkaisu:</strong> Tarkista palvelimen error_log tai käytä muita toimintoja.</small>
                    </div>
                `;
                
                showMockAlerts(container);
            }
            showLoading(false);
        }
        
        // Show mock alerts as fallback
        function showMockAlerts(container) {
            container.innerHTML += `
                <div class="alert medium" style="background: #e7f3ff; border-color: #0066cc;">
                    <strong>📊 Simuloidut Hälytykset (Varasuunnitelma)</strong><br>
                    Alla on esimerkkihälytyksiä järjestelmän toiminnasta:
                </div>
                <div class="alert medium">
                    <strong>TYÖLLISYYSTILANNE</strong><br>
                    Hämeenlinnan työttömyysaste nousussa<br>
                    <small>Todennäköisyys: 45.2%</small>
                </div>
                <div class="alert low">
                    <strong>KOULUTUS UUTISET</strong><br>
                    Uusi teknologia-ohjelma käynnistyy<br>
                    <small>Todennäköisyys: 23.1%</small>
                </div>
            `;
        }

        // Load weekly report from already analyzed database data
        async function loadWeeklyReport() {
            showLoading(true);
            updateStatus('Generating report from analyzed database data...', 'info');
            
            try {
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                // Get analyzed articles from both news_analysis and mediaseuranta tables
                const [newsResponse, mediaseurantaResponse] = await Promise.all([
                    fetch(`database_news_collector.php?action=weekly_stats&start_date=${startDate}&end_date=${endDate}`),
                    fetch(`mediaseuranta_analyzer.php?action=weekly_insights&start_date=${startDate}&end_date=${endDate}`)
                ]);
                
                let newsData = { analyzed_articles: [], stats: { total: 0 } };
                let mediaseurantaData = { insights: [], stats: { total: 0 } };
                
                // Try to get news analysis data
                if (newsResponse.ok) {
                    try {
                        newsData = await newsResponse.json();
                    } catch (e) {
                        console.warn('Failed to parse news data:', e);
                    }
                }
                
                // Try to get mediaseuranta analysis data
                if (mediaseurantaResponse.ok) {
                    try {
                        mediaseurantaData = await mediaseurantaResponse.json();
                    } catch (e) {
                        console.warn('Failed to parse mediaseuranta data:', e);
                    }
                }
                
                // Generate report from existing data
                const totalArticles = (newsData.stats?.total || 0) + (mediaseurantaData.stats?.total || 0);
                const allAnalyzedData = [...(newsData.analyzed_articles || []), ...(mediaseurantaData.insights || [])];
                
                // Calculate summary statistics
                const sentimentStats = calculateSentimentStats(allAnalyzedData);
                const sectorStats = calculateSectorStats(allAnalyzedData);
                const crisisStats = calculateCrisisStats(allAnalyzedData);
                const topKeywords = calculateTopKeywords(allAnalyzedData);
                
                // Generate executive summary
                const executiveSummary = generateExecutiveSummary(
                    totalArticles, 
                    sentimentStats, 
                    sectorStats, 
                    crisisStats
                );
                
                // Display report
                document.getElementById('report-content').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>📅 Raporttijakso: ${startDate} - ${endDate}</h3>
                        <p><strong>📊 Analysoidut artikkelit yhteensä:</strong> ${totalArticles}</p>
                        <p><strong>📂 Lähteet:</strong> ${newsData.stats?.total || 0} uutisartikkelia, ${mediaseurantaData.stats?.total || 0} mediaseurantamerkintää</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>🎯 Johtopäätökset</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            ${executiveSummary}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4>😊 Tunnelmajakauma</h4>
                            <ul>
                                <li>Positiivinen: ${sentimentStats.positive} (${((sentimentStats.positive/totalArticles)*100).toFixed(1)}%)</li>
                                <li>Neutraali: ${sentimentStats.neutral} (${((sentimentStats.neutral/totalArticles)*100).toFixed(1)}%)</li>
                                <li>Negatiivinen: ${sentimentStats.negative} (${((sentimentStats.negative/totalArticles)*100).toFixed(1)}%)</li>
                            </ul>
                        </div>
                        <div>
                            <h4>🚨 Kriisisignaalit</h4>
                            <ul>
                                <li>Korkea riski: ${crisisStats.high}</li>
                                <li>Keskitaso: ${crisisStats.medium}</li>
                                <li>Matala: ${crisisStats.low}</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>🏢 Päätoimialat</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${sectorStats.map(sector => `
                                <span style="background: #007bff; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                    ${sector.name} (${sector.count})
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>🔑 Avainsanat</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${topKeywords.map(keyword => `
                                <span style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em;">
                                    ${keyword.word} (${keyword.count})
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 5px;">
                        <small>
                            <strong>💡 Huomio:</strong> Raportti perustuu jo analysoiduille artikkeleille tietokannassa. 
                            Ei uusia OpenAI API-kutsuja. Luotu: ${new Date().toLocaleString('fi')}.
                        </small>
                    </div>
                `;
                
                document.getElementById('report-modal').style.display = 'block';
                updateStatus('Kuukausiraportti luotu tietokannasta', 'success');
                
            } catch (error) {
                console.error('Error loading report:', error);
                updateStatus('Raportin luonti epäonnistui', 'error');
                
                // Fallback message
                document.getElementById('report-content').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <h3>❌ Raportin luonti epäonnistui</h3>
                        <p>Virhe: ${error.message}</p>
                        <p>Varmista että tietokannassa on analysoituja artikkeleita.</p>
                        <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">
                            🤖 Analysoi Artikkeleita Ensin
                        </button>
                    </div>
                `;
                document.getElementById('report-modal').style.display = 'block';
            }
            showLoading(false);
        }
        
        // Helper functions for report generation
        function calculateSentimentStats(articles) {
            const stats = { positive: 0, neutral: 0, negative: 0 };
            articles.forEach(article => {
                const sentiment = (article.ai_sentiment || article.sentiment || '').toLowerCase();
                if (sentiment.includes('positive') || sentiment.includes('myönteinen')) {
                    stats.positive++;
                } else if (sentiment.includes('negative') || sentiment.includes('kielteinen')) {
                    stats.negative++;
                } else {
                    stats.neutral++;
                }
            });
            return stats;
        }
        
        function calculateSectorStats(articles) {
            const sectorCount = {};
            articles.forEach(article => {
                const sectors = article.ai_key_sectors_parsed || 
                              (article.themes ? JSON.parse(article.themes || '[]') : []);
                if (Array.isArray(sectors)) {
                    sectors.forEach(sector => {
                        const cleanSector = sector.trim();
                        if (cleanSector) {
                            sectorCount[cleanSector] = (sectorCount[cleanSector] || 0) + 1;
                        }
                    });
                }
            });
            
            return Object.entries(sectorCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8)
                .map(([name, count]) => ({ name, count }));
        }
        
        function calculateCrisisStats(articles) {
            const stats = { high: 0, medium: 0, low: 0 };
            articles.forEach(article => {
                const crisisProb = article.ai_crisis_probability || article.crisis_probability || 0;
                if (crisisProb > 0.7) {
                    stats.high++;
                } else if (crisisProb > 0.3) {
                    stats.medium++;
                } else {
                    stats.low++;
                }
            });
            return stats;
        }
        
        function calculateTopKeywords(articles) {
            const keywordCount = {};
            articles.forEach(article => {
                const keywords = article.ai_keywords_parsed || 
                               (article.entities ? JSON.parse(article.entities || '[]') : []);
                if (Array.isArray(keywords)) {
                    keywords.forEach(keyword => {
                        const cleanKeyword = keyword.trim();
                        if (cleanKeyword && cleanKeyword.length > 3) {
                            keywordCount[cleanKeyword] = (keywordCount[cleanKeyword] || 0) + 1;
                        }
                    });
                }
            });
            
            return Object.entries(keywordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 15)
                .map(([word, count]) => ({ word, count }));
        }
        
        function generateExecutiveSummary(totalArticles, sentimentStats, sectorStats, crisisStats) {
            if (totalArticles === 0) {
                return `<p>Ei analysoitua dataa valitulta kuukaudelta. Suorita ensin artikkelien analyysi.</p>`;
            }
            
            const dominantSentiment = Object.entries(sentimentStats)
                .sort(([,a], [,b]) => b - a)[0][0];
            
            const sentimentText = {
                'positive': 'myönteinen',
                'negative': 'kielteinen', 
                'neutral': 'neutraali'
            }[dominantSentiment] || 'sekoitettu';
            
            const topSectors = sectorStats.slice(0, 3).map(s => s.name).join(', ');
            
            const totalCrisis = crisisStats.high + crisisStats.medium;
            const crisisPercentage = ((totalCrisis / totalArticles) * 100).toFixed(1);
            
            return `
                <p><strong>Kuukauden aikana analysoitiin yhteensä ${totalArticles} artikkelia.</strong></p>
                <p>Yleinen tunnelma oli <strong>${sentimentText}</strong> 
                   (${sentimentStats.positive} positiivista, ${sentimentStats.neutral} neutraalia, ${sentimentStats.negative} negatiivista).</p>
                <p>Aktiivisimmat toimialat olivat: <strong>${topSectors}</strong>.</p>
                <p>Kriisipotentiaalia havaittiin ${crisisPercentage}% artikkeleista 
                   (${crisisStats.high} korkeaa riskiä, ${crisisStats.medium} keskitasoa).</p>
                ${crisisStats.high > 0 ? `<p><strong>⚠️ Huomio:</strong> ${crisisStats.high} artikkelia sisälsi korkeita kriisisignaaleja.</p>` : ''}
            `;
        }

        // Load competitive intelligence
        async function loadCompetitiveIntel() {
            showLoading(true);
            try {
                const response = await fetch('minimal_news_api.php?action=competitive_intelligence&days=30');
                const data = await response.json();
                
                const container = document.getElementById('competitive-container');
                
                // Show cost protection info and analysis count
                container.innerHTML = `
                    <div class="alert medium" style="background: #e8f5e8; border-color: #28a745;">
                        <strong>💰 Cost Protected Analysis</strong><br>
                        Articles Analyzed: ${data.articles_analyzed || 0} (max ${OPENAI_ANALYSIS_LIMIT})<br>
                        Stored to Database: ${data.analyses_stored || 0}<br>
                        Period: ${data.period_days || 30} days | ${data.cost_protection || 'Cost protection active'}
                    </div>
                    <h4>🏢 Companies Activity (${data.period_days || 30} days)</h4>
                    <div id="companies-list"></div>
                    <h4>💰 Funding Activities</h4>
                    <div id="funding-list"></div>
                    <h4>🚀 Market Opportunities</h4>
                    <div id="opportunities-list"></div>
                `;
                
                // Display companies activity
                const companiesList = document.getElementById('companies-list');
                const companiesData = data.companies_activity || {};
                if (Object.keys(companiesData).length === 0) {
                    companiesList.innerHTML = '<p style="color: #666;">No company activities detected in analyzed articles</p>';
                } else {
                    Object.entries(companiesData).forEach(([company, count]) => {
                        companiesList.innerHTML += `
                            <div class="metric">
                                <span><strong>${company}</strong></span>
                                <span class="metric-value">${count} mentions</span>
                            </div>
                        `;
                    });
                }
                
                // Display funding activities
                const fundingList = document.getElementById('funding-list');
                const fundingData = data.funding_activities || [];
                if (fundingData.length === 0) {
                    fundingList.innerHTML = '<p style="color: #666;">No funding activities detected</p>';
                } else {
                    fundingData.forEach(funding => {
                        fundingList.innerHTML += `
                            <div class="alert medium" style="margin-bottom: 10px;">
                                <strong>${funding.article_title || `Article ${funding.article_id}`}</strong><br>
                                <small><strong>Amounts:</strong> ${funding.amounts.join(', ') || 'N/A'}</small><br>
                                <small><strong>Sources:</strong> ${funding.sources.join(', ') || 'N/A'}</small><br>
                                <small><strong>Purposes:</strong> ${funding.purposes.join(', ') || 'N/A'}</small>
                            </div>
                        `;
                    });
                }
                
                // Display market opportunities
                const opportunitiesList = document.getElementById('opportunities-list');
                const opportunitiesData = data.market_opportunities || [];
                if (opportunitiesData.length === 0) {
                    opportunitiesList.innerHTML = '<p style="color: #666;">No market opportunities identified</p>';
                } else {
                    opportunitiesData.forEach((opportunity, index) => {
                        opportunitiesList.innerHTML += `
                            <div class="metric">
                                <span>📈 ${opportunity}</span>
                            </div>
                        `;
                    });
                }
                
                updateStatus(`Competitive intelligence updated (${data.articles_analyzed} articles, cost protected)`, 'success');
            } catch (error) {
                console.error('Error loading competitive intelligence:', error);
                
                // Show error with helpful information
                const container = document.getElementById('competitive-container');
                container.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Competitive Intelligence Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Possible causes:</small>
                        <ul style="margin-top: 10px; margin-bottom: 10px;">
                            <li>No articles analyzed yet (run basic analysis first)</li>
                            <li>Database schema needs updating for competitive intelligence</li>
                            <li>OpenAI API configuration issues</li>
                        </ul>
                        <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">
                            🤖 Analyze Articles First
                        </button>
                    </div>
                `;
                
                updateStatus('Failed to load competitive intelligence', 'error');
            }
            showLoading(false);
        }

        // Load mediaseuranta intelligence
        async function loadMediaseurantaIntelligence() {
            showLoading(true);
            try {
                const response = await fetch('minimal_news_api.php?action=mediaseuranta_analysis');
                const data = await response.json();
                
                const container = document.getElementById('mediaseuranta-container');
                
                // Show analysis summary and cost protection
                container.innerHTML = `
                    <div class="alert medium" style="background: #e8f4fd; border-color: #17a2b8;">
                        <strong>📊 Mediaseuranta Analysis Summary</strong><br>
                        New Analyzed: ${data.analysis_summary?.new_analyzed || 0} (max ${OPENAI_ANALYSIS_LIMIT})<br>
                        Total Entries: ${data.analysis_summary?.total_entries || 0}<br>
                        Period: ${data.analysis_summary?.period_days || 30} days | ${data.analysis_summary?.cost_protection || 'Cost protection active'}
                    </div>
                    <h4>📊 Teema-analyysi</h4>
                    <div id="theme-breakdown"></div>
                    <h4>😊 Sentimentti-yhteenveto</h4>
                    <div id="sentiment-breakdown"></div>
                    <h4>🚨 Kriisihälytykset</h4>
                    <div id="crisis-alerts"></div>
                    <h4>⭐ Korkean vaikutuksen uutiset</h4>
                    <div id="high-impact-news"></div>
                `;
                
                // Display theme breakdown
                const themeBreakdown = document.getElementById('theme-breakdown');
                const themes = data.theme_breakdown || {};
                if (Object.keys(themes).length === 0) {
                    themeBreakdown.innerHTML = '<p style="color: #666;">No themes analyzed yet</p>';
                } else {
                    Object.entries(themes).forEach(([theme, count]) => {
                        themeBreakdown.innerHTML += `
                            <div class="metric">
                                <span><strong>${theme}</strong></span>
                                <span class="metric-value">${count} uutista</span>
                            </div>
                        `;
                    });
                }
                
                // Display sentiment breakdown
                const sentimentBreakdown = document.getElementById('sentiment-breakdown');
                const sentiments = data.sentiment_summary || {positive: 0, neutral: 0, negative: 0};
                sentimentBreakdown.innerHTML = `
                    <div class="metric">
                        <span>😊 Positiivinen</span>
                        <span class="metric-value" style="color: #28a745;">${sentiments.positive || 0}</span>
                    </div>
                    <div class="metric">
                        <span>😐 Neutraali</span>
                        <span class="metric-value" style="color: #6c757d;">${sentiments.neutral || 0}</span>
                    </div>
                    <div class="metric">
                        <span>😟 Negatiivinen</span>
                        <span class="metric-value" style="color: #dc3545;">${sentiments.negative || 0}</span>
                    </div>
                `;
                
                // Display crisis alerts
                const crisisAlerts = document.getElementById('crisis-alerts');
                const crises = data.crisis_alerts || [];
                if (crises.length === 0) {
                    crisisAlerts.innerHTML = '<p style="color: #666;">No crisis signals detected</p>';
                } else {
                    crises.forEach(crisis => {
                        const probability = Math.round((crisis.probability || 0) * 100);
                        crisisAlerts.innerHTML += `
                            <div class="alert high" style="margin-bottom: 10px;">
                                <strong>⚠️ ${crisis.title}</strong><br>
                                <small><strong>Probability:</strong> ${probability}% | <strong>Date:</strong> ${crisis.date}</small><br>
                                <small><strong>Theme:</strong> ${crisis.theme}</small>
                            </div>
                        `;
                    });
                }
                
                // Display high impact news
                const highImpactNews = document.getElementById('high-impact-news');
                const highImpact = data.high_impact_news || [];
                if (highImpact.length === 0) {
                    highImpactNews.innerHTML = '<p style="color: #666;">No high-impact news identified</p>';
                } else {
                    highImpact.forEach(news => {
                        const impactColor = news.impact === 'positive' ? '#28a745' : 
                                          news.impact === 'negative' ? '#dc3545' : '#6c757d';
                        highImpactNews.innerHTML += `
                            <div class="alert medium" style="margin-bottom: 10px; border-left: 4px solid ${impactColor};">
                                <strong>${news.title}</strong><br>
                                <small><strong>Score:</strong> ${news.score}/10 | <strong>Impact:</strong> ${news.impact} | <strong>Date:</strong> ${news.date}</small><br>
                                <small>${news.summary || 'No summary available'}</small>
                            </div>
                        `;
                    });
                }
                
                updateStatus(`Mediaseuranta insights updated (${data.analysis_summary?.new_analyzed || 0} new analyses, cost protected)`, 'success');
            } catch (error) {
                console.error('Error loading mediaseuranta intelligence:', error);
                
                // Show error with helpful information
                const container = document.getElementById('mediaseuranta-container');
                container.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Mediaseuranta Intelligence Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Possible causes:</small>
                        <ul style="margin-top: 10px; margin-bottom: 10px;">
                            <li>Mediaseuranta table not available or empty</li>
                            <li>AI analysis columns not added to database</li>
                            <li>OpenAI API configuration issues</li>
                        </ul>
                        <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">
                            📰 Try Existing Mediaseuranta Analysis
                        </button>
                    </div>
                `;
                
                updateStatus('Failed to load mediaseuranta intelligence', 'error');
            }
            showLoading(false);
        }

        // Load mediaseuranta competitive intelligence
        async function loadMediaseurantaCompetitive() {
            showLoading(true);
            try {
                const response = await fetch('minimal_news_api.php?action=mediaseuranta_competitive&days=30');
                const data = await response.json();
                
                const container = document.getElementById('mediaseuranta-competitive-container');
                
                // Show analysis summary and cost protection
                container.innerHTML = `
                    <div class="alert medium" style="background: #e8f0fe; border-color: #2c3e50;">
                        <strong>🏢 Mediaseuranta Competitive Analysis</strong><br>
                        New Analyzed: ${data.analysis_summary?.new_analyzed || 0} (max ${OPENAI_ANALYSIS_LIMIT})<br>
                        Total Insights: ${data.analysis_summary?.total_competitive_insights || 0}<br>
                        Period: ${data.analysis_summary?.period_days || 30} days | ${data.analysis_summary?.cost_protection || 'Cost protection active'}
                    </div>
                    <h4>🏢 Companies Activity</h4>
                    <div id="mediaseuranta-companies-list"></div>
                    <h4>💰 Funding Intelligence</h4>
                    <div id="mediaseuranta-funding-list"></div>
                    <h4>⭐ Strategic High Priority</h4>
                    <div id="mediaseuranta-strategic-list"></div>
                    <h4>⚠️ Competitive Threats</h4>
                    <div id="mediaseuranta-threats-list"></div>
                `;
                
                // Display companies activity
                const companiesList = document.getElementById('mediaseuranta-companies-list');
                const companiesData = data.companies_activity || {};
                if (Object.keys(companiesData).length === 0) {
                    companiesList.innerHTML = '<p style="color: #666;">No company activities detected</p>';
                } else {
                    Object.entries(companiesData).forEach(([company, count]) => {
                        companiesList.innerHTML += `
                            <div class="metric">
                                <span><strong>${company}</strong></span>
                                <span class="metric-value">${count} mentions</span>
                            </div>
                        `;
                    });
                }
                
                // Display funding intelligence
                const fundingList = document.getElementById('mediaseuranta-funding-list');
                const fundingData = data.funding_activities || [];
                if (fundingData.length === 0) {
                    fundingList.innerHTML = '<p style="color: #666;">No funding activities detected</p>';
                } else {
                    fundingData.forEach(funding => {
                        fundingList.innerHTML += `
                            <div class="alert medium" style="margin-bottom: 10px;">
                                <strong>${funding.title}</strong><br>
                                <small><strong>Date:</strong> ${funding.date} | <strong>Amounts:</strong> ${funding.amounts.join(', ') || 'N/A'}</small><br>
                                <small><strong>Sources:</strong> ${funding.sources.join(', ') || 'N/A'}</small>
                            </div>
                        `;
                    });
                }
                
                // Display strategic high priority items
                const strategicList = document.getElementById('mediaseuranta-strategic-list');
                const strategicData = data.strategic_high_priority || [];
                if (strategicData.length === 0) {
                    strategicList.innerHTML = '<p style="color: #666;">No high-priority strategic items</p>';
                } else {
                    strategicData.forEach(item => {
                        const relevanceColor = item.relevance === 'high' ? '#dc3545' : 
                                             item.relevance === 'medium' ? '#ffc107' : '#28a745';
                        strategicList.innerHTML += `
                            <div class="alert high" style="margin-bottom: 10px; border-left: 4px solid ${relevanceColor};">
                                <strong>🔥 ${item.title}</strong><br>
                                <small><strong>Importance:</strong> ${item.importance}/5 | <strong>Score:</strong> ${Math.round((item.score || 0) * 100)}% | <strong>Date:</strong> ${item.date}</small>
                            </div>
                        `;
                    });
                }
                
                // Display competitive threats
                const threatsList = document.getElementById('mediaseuranta-threats-list');
                const threatsData = data.competitive_threats || [];
                if (threatsData.length === 0) {
                    threatsList.innerHTML = '<p style="color: #666;">No competitive threats identified</p>';
                } else {
                    threatsData.forEach(threat => {
                        threatsList.innerHTML += `
                            <div class="alert high" style="margin-bottom: 8px;">
                                <span>⚠️ ${threat}</span>
                            </div>
                        `;
                    });
                }
                
                updateStatus(`Mediaseuranta competitive intelligence updated (${data.analysis_summary?.new_analyzed || 0} new analyses, cost protected)`, 'success');
            } catch (error) {
                console.error('Error loading mediaseuranta competitive intelligence:', error);
                
                // Show error with helpful information
                const container = document.getElementById('mediaseuranta-competitive-container');
                container.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Mediaseuranta Competitive Intelligence Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Possible causes:</small>
                        <ul style="margin-top: 10px; margin-bottom: 10px;">
                            <li>Competitive intelligence columns not added to Mediaseuranta table</li>
                            <li>No mediaseuranta entries with general AI analysis completed</li>
                            <li>OpenAI API configuration issues</li>
                        </ul>
                        <button class="btn" onclick="loadMediaseurantaIntelligence()" style="margin-top: 10px;">
                            📊 Try General Mediaseuranta Analysis First
                        </button>
                    </div>
                `;
                
                updateStatus('Failed to load mediaseuranta competitive intelligence', 'error');
            }
            showLoading(false);
        }

        // Update chart functions
        function updateVolumeChart() {
            const dates = [];
            const values = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                dates.push(date.toLocaleDateString('fi'));
                values.push(Math.floor(Math.random() * 50) + 10);
            }
            
            volumeChart.data.labels = dates;
            volumeChart.data.datasets[0].data = values;
            volumeChart.update();
        }

        function updateSentimentChart() {
            sentimentChart.data.datasets[0].data = [
                Math.floor(Math.random() * 40) + 30,
                Math.floor(Math.random() * 30) + 20,
                Math.floor(Math.random() * 20) + 10
            ];
            sentimentChart.update();
        }

        function updateThemeChart() {
            const themes = ['Työllisyys', 'Koulutus', 'Teknologia', 'Talous', 'Ympäristö'];
            const values = themes.map(() => Math.floor(Math.random() * 30) + 5);
            
            themeChart.data.labels = themes;
            themeChart.data.datasets[0].data = values;
            themeChart.update();
        }

        function updateMetrics() {
            document.getElementById('articles-count').textContent = Math.floor(Math.random() * 100) + 50;
            document.getElementById('crisis-count').textContent = Math.floor(Math.random() * 5);
            document.getElementById('impact-count').textContent = Math.floor(Math.random() * 10);
            document.getElementById('sentiment-avg').textContent = (Math.random() * 0.4 + 0.3).toFixed(2);
        }

        // Update charts with Mediaseuranta AI analysis data
        function updateChartsWithMediaseurantaData(insights) {
            // Update Volume Chart with entry frequency over time
            updateVolumeChartWithMediaseuranta(insights);
            
            // Update Sentiment Chart with AI sentiment analysis
            updateSentimentChartWithMediaseuranta(insights);
            
            // Update Theme Chart with AI key sectors
            updateThemeChartWithMediaseuranta(insights);
        }

        function updateVolumeChartWithMediaseuranta(insights) {
            // Group entries by date and count frequency
            const dateCount = {};
            insights.forEach(entry => {
                const date = entry.uutisen_pvm ? entry.uutisen_pvm.split(' ')[0] : 'Unknown';
                dateCount[date] = (dateCount[date] || 0) + 1;
            });
            
            // Get dates from last 3 months instead of just 7 days (for Mediaseuranta data)
            const allDates = Object.keys(dateCount).sort();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            
            // Filter dates to last 3 months and take up to 20 most recent dates
            const recentDates = allDates.filter(date => {
                try {
                    const entryDate = new Date(date);
                    return entryDate >= threeMonthsAgo;
                } catch (e) {
                    return false; // Skip invalid dates
                }
            }).slice(-20); // Show max 20 data points for readability
            
            const volumes = recentDates.map(date => dateCount[date] || 0);
            
            // Format dates for display (shorter format for 3 months of data)
            const displayDates = recentDates.map(date => {
                try {
                    const d = new Date(date);
                    return d.toLocaleDateString('fi', { 
                        month: 'short', 
                        day: 'numeric'
                    });
                } catch (e) {
                    return date;
                }
            });
            
            volumeChart.data.labels = displayDates.length > 0 ? displayDates : ['No Data'];
            volumeChart.data.datasets[0].data = volumes.length > 0 ? volumes : [0];
            volumeChart.data.datasets[0].label = 'Mediaseuranta Entries (3 months)';
            volumeChart.update();
        }

        function updateSentimentChartWithMediaseuranta(insights) {
            // Count sentiment distribution from AI analysis
            let positive = 0, neutral = 0, negative = 0;
            
            insights.forEach(entry => {
                const sentiment = (entry.ai_sentiment || '').toLowerCase();
                if (sentiment.includes('positive') || sentiment.includes('myönteinen')) {
                    positive++;
                } else if (sentiment.includes('negative') || sentiment.includes('kielteinen')) {
                    negative++;
                } else {
                    neutral++;
                }
            });
            
            // If no data, show equal distribution
            if (positive + neutral + negative === 0) {
                positive = neutral = negative = 1;
            }
            
            sentimentChart.data.labels = ['Positive', 'Neutral', 'Negative'];
            sentimentChart.data.datasets[0].data = [positive, neutral, negative];
            sentimentChart.update();
        }

        function updateThemeChartWithMediaseuranta(insights) {
            // Count key sectors frequency from AI analysis
            const sectorCount = {};
            
            insights.forEach(entry => {
                if (entry.ai_key_sectors_parsed && Array.isArray(entry.ai_key_sectors_parsed)) {
                    entry.ai_key_sectors_parsed.forEach(sector => {
                        const cleanSector = sector.trim();
                        if (cleanSector) {
                            sectorCount[cleanSector] = (sectorCount[cleanSector] || 0) + 1;
                        }
                    });
                }
            });
            
            // Get top 5 sectors
            const sortedSectors = Object.entries(sectorCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            if (sortedSectors.length > 0) {
                themeChart.data.labels = sortedSectors.map(([sector]) => sector);
                themeChart.data.datasets[0].data = sortedSectors.map(([,count]) => count);
                themeChart.data.datasets[0].label = 'Sector Frequency';
            } else {
                // Fallback data
                themeChart.data.labels = ['No Sector Data'];
                themeChart.data.datasets[0].data = [0];
                themeChart.data.datasets[0].label = 'Sector Frequency';
            }
            
            themeChart.update();
        }

        function updateMetricsWithMediaseurantaData(insights) {
            // Update metrics with real Mediaseuranta data
            document.getElementById('articles-count').textContent = insights.length;
            
            // Count high-impact entries (relevance >= 8)
            const highImpact = insights.filter(entry => entry.ai_relevance_score >= 8).length;
            document.getElementById('impact-count').textContent = highImpact;
            
            // Count crisis-related entries (high relevance + negative sentiment)
            const crisisSignals = insights.filter(entry => 
                entry.ai_relevance_score >= 7 && 
                (entry.ai_sentiment || '').toLowerCase().includes('negative')
            ).length;
            document.getElementById('crisis-count').textContent = crisisSignals;
            
            // Calculate average relevance score
            const avgRelevance = insights.length > 0 
                ? (insights.reduce((sum, entry) => sum + (entry.ai_relevance_score || 0), 0) / insights.length / 10).toFixed(2)
                : '0.00';
            document.getElementById('sentiment-avg').textContent = avgRelevance;
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'inline' : 'none';
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        function closeReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        // Collect news to database
        async function collectToDatabase() {
            showLoading(true);
            updateStatus('Collecting and storing news to database...', 'warning');
            
            try {
                const response = await fetch('database_news_collector.php?action=collect');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.collection_stats;
                    const dbStats = data.database_stats;
                    
                    updateStatus(`✅ Success! Stored ${stats.new_articles_stored} new articles (${stats.hame_relevant_articles} Häme relevant)`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>💾 Database Collection Complete!</h4>
                        
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>📊 Collection Results:</strong><br>
                            • New Articles Stored: ${stats.new_articles_stored}<br>
                            • Häme Relevant: ${stats.hame_relevant_articles}<br>
                            • Duplicates Skipped: ${stats.duplicates_skipped}<br>
                            • Total in Database: ${dbStats.total_articles}
                        </div>
                        
                        <h4>📡 Source Performance:</h4>
                    `;
                    
                    // Show source details
                    Object.entries(stats.source_details).forEach(([source, details]) => {
                        const statusIcon = details.status === 'success' ? '✅' : '❌';
                        const alertClass = details.status === 'success' ? 'medium' : 'high';
                        
                        alertsContainer.innerHTML += `
                            <div class="alert ${alertClass}">
                                ${statusIcon} <strong>${source}</strong><br>
                                ${details.status === 'success' ? 
                                    `Found: ${details.articles_found} | Stored: ${details.new_stored} | Häme: ${details.hame_relevant}` : 
                                    `Error: ${details.error}`
                                }
                            </div>
                        `;
                    });
                    
                    // Show database stats
                    if (dbStats.by_source && Object.keys(dbStats.by_source).length > 0) {
                        alertsContainer.innerHTML += '<h4>📈 Database Statistics:</h4>';
                        Object.entries(dbStats.by_source).forEach(([source, count]) => {
                            alertsContainer.innerHTML += `
                                <div class="metric">
                                    <span>${source}</span>
                                    <span class="metric-value">${count}</span>
                                </div>
                            `;
                        });
                    }
                    
                    alertsContainer.innerHTML += `
                        <div class="alert" style="background: #e8f5e8; border-color: #28a745; margin-top: 15px;">
                            <strong>🎉 Database Collection Working!</strong><br>
                            • Articles ready for AI analysis<br>
                            • Historical data building up<br>
                            • Ready for trend analysis<br>
                            <button class="btn" onclick="viewStoredNews()" style="margin-top: 10px;">📋 View Stored Articles</button>
                        </div>
                    `;
                    
                    // Auto-refresh metrics
                    setTimeout(() => {
                        updateMetrics();
                    }, 2000);
                    
                } else {
                    updateStatus(`Database collection failed: ${data.error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Database Collection Failed</strong><br>
                            Error: ${data.error}<br>
                            <p>Possible solutions:</p>
                            <ul>
                                <li>Check if news_articles table exists</li>
                                <li>Verify database permissions</li>
                                <li>Run create_news_tables.sql if needed</li>
                            </ul>
                            <button class="btn" onclick="workingTest()" style="margin-top: 10px;">✅ Kokeile Toimivuustestiä</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in database collection:', error);
                updateStatus('Database collection failed - check console', 'error');
            }
            showLoading(false);
        }

        // View stored news from database
        async function viewStoredNews() {
            showLoading(true);
            updateStatus('Loading stored news from database...', 'warning');
            
            try {
                const response = await fetch('database_news_collector.php?action=recent&limit=10');
                const data = await response.json();
                
                updateStatus(`📋 Loaded ${data.count} recent articles from database`, 'success');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '<h4>📋 Recent Articles from Database:</h4>';
                
                if (data.recent_articles && data.recent_articles.length > 0) {
                    data.recent_articles.forEach((article, index) => {
                        const relevanceData = article.region_relevance ? JSON.parse(article.region_relevance) : {};
                        const relevanceIcon = relevanceData.is_relevant ? '🎯' : '📰';
                        
                        alertsContainer.innerHTML += `
                            <div class="alert medium">
                                ${relevanceIcon} <strong>${article.title}</strong><br>
                                <small>${article.content}</small><br>
                                <small>
                                    Source: ${article.source} | 
                                    Published: ${article.published_date} | 
                                    Collected: ${article.collected_at}
                                    ${relevanceData.keywords ? ' | Keywords: ' + relevanceData.keywords.join(', ') : ''}
                                </small>
                            </div>
                        `;
                    });
                    
                    alertsContainer.innerHTML += `
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="collectToDatabase()">💾 Collect More News</button>
                            <button class="btn" onclick="getDatabaseStats()">📊 View Statistics</button>
                        </div>
                    `;
                } else {
                    alertsContainer.innerHTML += `
                        <div class="alert medium">
                            No articles found in database yet.<br>
                            <button class="btn" onclick="collectToDatabase()" style="margin-top: 10px;">💾 Start Collecting</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error viewing stored news:', error);
                updateStatus('Failed to load stored news', 'error');
            }
            showLoading(false);
        }

        // Get database statistics
        async function getDatabaseStats() {
            try {
                const response = await fetch('database_news_collector.php?action=stats');
                const data = await response.json();
                
                if (data.database_stats) {
                    const stats = data.database_stats;
                    
                    // Update metrics display
                    document.getElementById('articles-count').textContent = stats.total_articles || 0;
                    document.getElementById('crisis-count').textContent = '0'; // Will be calculated later
                    document.getElementById('impact-count').textContent = stats.pending_analysis || 0;
                    document.getElementById('sentiment-avg').textContent = '0.65'; // Sample
                    
                    updateStatus(`📊 Database stats updated: ${stats.total_articles} articles total`, 'success');
                }
            } catch (error) {
                console.error('Error getting database stats:', error);
            }
        }

        // Update metrics from database
        function updateMetrics() {
            getDatabaseStats();
        }

        // Working test with fixed RSS URLs
        async function workingTest() {
            showLoading(true);
            updateStatus('Testing with corrected RSS URLs...', 'warning');
            
            try {
                const response = await fetch('news_working_test.php?action=real_news');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(`✅ REAL NEWS COLLECTION WORKING! ${data.total_articles} articles found`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🎉 SUCCESS! Real News Collection Working!</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>✅ Network Issue Solved!</strong><br>
                            Total Articles: ${data.total_articles}<br>
                            Häme Relevant: ${data.hame_relevant}<br>
                            Method: ${data.method}
                        </div>
                    `;
                    
                    // Show source results
                    if (data.source_results) {
                        alertsContainer.innerHTML += '<h4>📡 RSS Source Status:</h4>';
                        Object.entries(data.source_results).forEach(([source, result]) => {
                            const statusIcon = result.status === 'success' ? '✅' : '❌';
                            const alertClass = result.status === 'success' ? 'medium' : 'high';
                            alertsContainer.innerHTML += `
                                <div class="alert ${alertClass}">
                                    ${statusIcon} <strong>${source}</strong><br>
                                    Status: ${result.status}<br>
                                    ${result.articles_found !== undefined ? `Articles: ${result.articles_found}` : ''}
                                    ${result.error ? `Error: ${result.error}` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    // Show Häme-relevant articles
                    if (data.hame_articles && data.hame_articles.length > 0) {
                        alertsContainer.innerHTML += '<h4>🎯 Häme Region News:</h4>';
                        data.hame_articles.forEach(article => {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <strong>${article.title}</strong><br>
                                    <small>${article.description}</small><br>
                                    <small>Keywords: ${article.matched_keywords.join(', ')}</small><br>
                                    <small>Source: ${article.source} | ${article.pub_date}</small>
                                </div>
                            `;
                        });
                    }
                    
                    // Automatically start full system test
                    setTimeout(() => {
                        runAnalysis();
                    }, 2000);
                    
                } else {
                    updateStatus(`Working test failed: ${data.error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Still Having Issues</strong><br>
                            Error: ${data.error}<br>
                            <button class="btn" onclick="mockTest()" style="margin-top: 10px;">📋 Use Mock Data Instead</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in working test:', error);
                updateStatus('Working test failed - trying mock data', 'warning');
                setTimeout(() => mockTest(), 1000);
            }
            showLoading(false);
        }

        async function analyzeStoredArticles() {
            showLoading(true);
            updateStatus('Analyzing stored articles with AI (batch processing)...', 'warning');
            
            try {
                // First, check how many articles need analysis
                const statsResponse = await fetch('database_news_collector.php?action=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.database_stats && statsData.database_stats.pending_analysis > 0) {
                    updateStatus(`Found ${statsData.database_stats.pending_analysis} articles to analyze...`, 'info');
                } else {
                    updateStatus('No articles need analysis', 'success');
                    showLoading(false);
                    return;
                }
                
                // Start analysis with small batch size for reliability
                const response = await fetch(`database_news_collector.php?action=analyze&batch_size=${OPENAI_ANALYSIS_LIMIT}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }
                
                const data = await response.json();
                
                if (data.analysis_result && data.analysis_result.success) {
                    const result = data.analysis_result;
                    updateStatus(`✅ Batch completed! ${result.analyzed} articles analyzed`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🤖 AI Analysis Batch Completed</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>✅ Batch Results:</strong><br>
                            Articles Analyzed: ${result.analyzed}<br>
                            Failed: ${result.failed}<br>
                            Skipped (Already Analyzed): ${result.skipped}<br>
                            Success Rate: ${result.success_rate}%<br>
                            Processing Time: ${result.processing_time}<br>
                            Batch Size: ${result.batch_size}
                        </div>
                    `;
                    
                    // Show errors if any
                    if (result.errors && result.errors.length > 0) {
                        alertsContainer.innerHTML += `
                            <h4>⚠️ Issues Encountered:</h4>
                            <div class="alert medium" style="background: #fff3cd;">
                        `;
                        result.errors.slice(0, 5).forEach(error => {
                            alertsContainer.innerHTML += `<small>• ${error}</small><br>`;
                        });
                        if (result.errors.length > 5) {
                            alertsContainer.innerHTML += `<small>... and ${result.errors.length - 5} more errors</small><br>`;
                        }
                        alertsContainer.innerHTML += `</div>`;
                    }
                    
                    // Check if more articles need analysis
                    if (result.analyzed > 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff;">
                                <strong>💡 Continue Processing?</strong><br>
                                <small>This batch processed ${result.batch_size} articles. More may need analysis.</small><br>
                                <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">🔄 Analyze Next Batch</button>
                                <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">📊 Check Status</button>
                            </div>
                        `;
                    }
                    
                    // Refresh dashboard data
                    setTimeout(() => {
                        getDatabaseStats();
                    }, 2000);
                    
                } else {
                    const error = data.error || data.analysis_result?.errors?.join(', ') || 'Unknown error occurred';
                    updateStatus(`Analysis failed: ${error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Analysis Failed</strong><br>
                            Error: ${error}<br>
                            <small>Try with a smaller batch or check your OpenAI API key configuration.</small><br>
                            <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">📊 Check Database Status</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in analysis:', error);
                updateStatus('Analysis failed - check console for details', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Network or Processing Error</strong><br>
                        Error: ${error.message}<br>
                        <small>This might be due to timeout, network issues, or server overload.</small><br>
                        <button class="btn" onclick="analyzeStoredArticles()" style="margin-top: 10px;">🔄 Try Again</button>
                        <button class="btn" onclick="getDatabaseStats()" style="margin-top: 10px;">📊 Check Status</button>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Analyze Mediaseuranta entries with AI
        async function analyzeMediaseuranta() {
            showLoading(true);
            updateStatus('Analyzing Mediaseuranta entries with AI...', 'warning');
            
            try {
                // Check stats first
                const statsResponse = await fetch('mediaseuranta_analyzer.php?action=stats');
                const statsData = await statsResponse.json();
                
                if (statsData.mediaseuranta_stats) {
                    const stats = statsData.mediaseuranta_stats;
                    const pending = stats.by_status?.pending || 0;
                    
                    if (pending === 0) {
                        updateStatus('All Mediaseuranta entries are already analyzed', 'success');
                        showLoading(false);
                        return;
                    }
                    
                    updateStatus(`Found ${pending} Mediaseuranta entries to analyze...`, 'info');
                }
                
                // Start analysis
                const response = await fetch(`mediaseuranta_analyzer.php?action=analyze&batch_size=${OPENAI_ANALYSIS_LIMIT}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.mediaseuranta_analysis && data.mediaseuranta_analysis.success) {
                    const result = data.mediaseuranta_analysis;
                    updateStatus(`✅ Mediaseuranta analysis completed! ${result.analyzed} entries analyzed`, 'success');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>📰 Mediaseuranta Analysis Completed</h4>
                        <div class="alert medium" style="background: #d4edda; border-color: #c3e6cb;">
                            <strong>✅ Analysis Results:</strong><br>
                            Entries Analyzed: ${result.analyzed}<br>
                            Failed: ${result.failed}<br>
                            Success Rate: ${result.success_rate}%<br>
                            Processing Time: ${result.processing_time}<br>
                            Batch Size: ${result.batch_size}
                        </div>
                    `;
                    
                    // Show continue button if needed
                    if (result.analyzed > 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff;">
                                <strong>💡 Continue Processing?</strong><br>
                                <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">🔄 Analyze Next Batch</button>
                                <button class="btn" onclick="viewMediaseurantaInsights()" style="margin-top: 10px;">📊 View Insights</button>
                            </div>
                        `;
                    }
                    
                } else {
                    const error = data.error || 'Unknown error occurred';
                    updateStatus(`Mediaseuranta analysis failed: ${error}`, 'error');
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <div class="alert high">
                            <strong>❌ Analysis Failed</strong><br>
                            Error: ${error}<br>
                            <small>Check database connection and OpenAI API configuration.</small>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error in Mediaseuranta analysis:', error);
                updateStatus('Mediaseuranta analysis failed - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Network Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Check your connection and try again.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // View Mediaseuranta AI insights
        async function viewMediaseurantaInsights() {
            showLoading(true);
            updateStatus('Loading Mediaseuranta AI insights...', 'info');
            
            try {
                const response = await fetch('mediaseuranta_analyzer.php?action=insights&limit=100&min_relevance=3');
                const data = await response.json();
                
                if (data.mediaseuranta_insights) {
                    const insights = data.mediaseuranta_insights;
                    updateStatus(`✅ Loaded ${insights.length} analyzed Mediaseuranta entries`, 'success');
                    
                    // Update charts with Mediaseuranta data
                    updateChartsWithMediaseurantaData(insights);
                    updateMetricsWithMediaseurantaData(insights);
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>📊 Mediaseuranta AI Insights</h4>
                    `;
                    
                    if (insights.length === 0) {
                        alertsContainer.innerHTML += `
                            <div class="alert medium">
                                <strong>No analyzed entries found</strong><br>
                                <small>Run analysis first to generate insights.</small><br>
                                <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">📰 Start Analysis</button>
                            </div>
                        `;
                    } else {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #e7f3ff; border-color: #0066cc;">
                                <strong>📈 Kaaviot Päivitetty!</strong><br>
                                Kaaviot näyttävät nyt Mediaseurannan AI-analyysidatan: tunnelmajakauma, toimialafrekvenssi ja alueelliset trendit.<br>
                                <small>Tieto ${insights.length} analysoidusta merkinnästä, relevanssi ≥3</small>
                            </div>
                        `;
                        
                        insights.slice(0, 10).forEach(entry => {
                            const sectors = entry.ai_key_sectors_parsed ? entry.ai_key_sectors_parsed.slice(0, 3).join(', ') : 'N/A';
                            const keywords = entry.ai_keywords_parsed ? entry.ai_keywords_parsed.slice(0, 5).join(', ') : 'N/A';
                            
                            const alertClass = entry.ai_relevance_score >= 8 ? 'high' : 
                                               entry.ai_relevance_score >= 6 ? 'medium' : 'low';
                            
                            alertsContainer.innerHTML += `
                                <div class="alert ${alertClass}">
                                    <strong>${entry.Maakunta_Nimi} - ${entry.Teema}</strong><br>
                                    <small><strong>Date:</strong> ${entry.uutisen_pvm}</small><br>
                                    <small><strong>News:</strong> ${entry.Uutinen.substring(0, 150)}...</small><br>
                                    <small><strong>Relevance:</strong> ${entry.ai_relevance_score}/10 | 
                                    <strong>Impact:</strong> ${entry.ai_economic_impact} | 
                                    <strong>Sentiment:</strong> ${entry.ai_sentiment}</small><br>
                                    <small><strong>Sectors:</strong> ${sectors}</small><br>
                                    <small><strong>Keywords:</strong> ${keywords}</small><br>
                                    ${entry.ai_summary ? `<small><strong>Summary:</strong> ${entry.ai_summary}</small><br>` : ''}
                                    ${entry.Url ? `<small><a href="${entry.Url}" target="_blank">🔗 Read more</a></small>` : ''}
                                </div>
                            `;
                        });
                        
                        if (insights.length > 10) {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <small>Showing 10 of ${insights.length} entries. Use API for complete data.</small>
                                </div>
                            `;
                        }
                    }
                    
                } else {
                    updateStatus('Failed to load Mediaseuranta insights', 'error');
                }
                
            } catch (error) {
                console.error('Error loading insights:', error);
                updateStatus('Failed to load insights - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Failed to Load Insights</strong><br>
                        Error: ${error.message}<br>
                        <small>Check database connection and try again.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Debug Mediaseuranta connection and structure
        async function debugMediaseuranta() {
            showLoading(true);
            updateStatus('Checking Mediaseuranta database structure...', 'info');
            
            try {
                const response = await fetch('mediaseuranta_analyzer.php?action=debug');
                const data = await response.json();
                
                if (data.debug_info) {
                    const info = data.debug_info;
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🔧 Mediaseuranta Debug Information</h4>
                    `;
                    
                    if (info.error) {
                        alertsContainer.innerHTML += `
                            <div class="alert high">
                                <strong>❌ Error:</strong> ${info.error}<br>
                                <small>This is likely the cause of the 500 error.</small>
                            </div>
                        `;
                        updateStatus('Debug found error - check results', 'error');
                    } else {
                        // Database connection
                        alertsContainer.innerHTML += `
                            <div class="alert ${info.database_connection === 'OK' ? 'medium' : 'high'}">
                                <strong>Database Connection:</strong> ${info.database_connection}<br>
                                <strong>Table Exists:</strong> ${info.table_exists ? 'Yes' : 'No'}<br>
                                <strong>Total Entries:</strong> ${info.total_entries || 'N/A'}
                            </div>
                        `;
                        
                        // AI columns check
                        const aiColumnsHtml = Object.entries(info.ai_columns_exist || {})
                            .map(([col, exists]) => `${col}: ${exists ? '✅' : '❌'}`)
                            .join('<br>');
                        
                        const allAiColumnsExist = Object.values(info.ai_columns_exist || {}).every(exists => exists);
                        
                        alertsContainer.innerHTML += `
                            <div class="alert ${allAiColumnsExist ? 'medium' : 'high'}">
                                <strong>AI Columns Status:</strong><br>
                                ${aiColumnsHtml}<br>
                                ${!allAiColumnsExist ? '<br><strong>⚠️ Missing AI columns! Run the SQL script first.</strong>' : ''}
                            </div>
                        `;
                        
                        // Show all columns for reference
                        if (info.columns && info.columns.length > 0) {
                            alertsContainer.innerHTML += `
                                <div class="alert medium">
                                    <strong>All Table Columns:</strong><br>
                                    <small>${info.columns.join(', ')}</small>
                                </div>
                            `;
                        }
                        
                        // Recommendations
                        if (!info.table_exists) {
                            alertsContainer.innerHTML += `
                                <div class="alert high">
                                    <strong>🚨 Action Required:</strong><br>
                                    Mediaseuranta table not found. Check database name and connection.
                                </div>
                            `;
                        } else if (!allAiColumnsExist) {
                            alertsContainer.innerHTML += `
                                <div class="alert high">
                                    <strong>🚨 Action Required:</strong><br>
                                    Run the SQL script: add_mediaseuranta_ai_columns.sql<br>
                                    This will add the missing AI analysis columns to your table.
                                </div>
                            `;
                        } else {
                            alertsContainer.innerHTML += `
                                <div class="alert medium" style="background: #d4edda;">
                                    <strong>✅ Everything looks good!</strong><br>
                                    You can now try running the analysis.
                                </div>
                            `;
                        }
                        
                        updateStatus('Debug completed successfully', 'success');
                    }
                } else {
                    updateStatus('Debug failed to return information', 'error');
                }
                
            } catch (error) {
                console.error('Error in debug:', error);
                updateStatus('Debug failed - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Debug Error</strong><br>
                        Error: ${error.message}<br>
                        <small>This might be the cause of the 500 error.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Test basic data retrieval from Mediaseuranta
        async function testMediaseuranta() {
            showLoading(true);
            updateStatus('Testing data retrieval from Mediaseuranta...', 'info');
            
            try {
                const response = await fetch('mediaseuranta_analyzer.php?action=test');
                const data = await response.json();
                
                if (data.test_result) {
                    const result = data.test_result;
                    
                    const alertsContainer = document.getElementById('alerts-container');
                    alertsContainer.innerHTML = `
                        <h4>🧪 Mediaseuranta Data Test Results</h4>
                    `;
                    
                    if (result.error) {
                        alertsContainer.innerHTML += `
                            <div class="alert high">
                                <strong>❌ Test Failed:</strong> ${result.error}<br>
                                <small>This indicates the specific problem with data access.</small>
                            </div>
                        `;
                        updateStatus('Data test failed - see error above', 'error');
                    } else {
                        alertsContainer.innerHTML += `
                            <div class="alert medium" style="background: #d4edda;">
                                <strong>✅ Data Access Working!</strong><br>
                                Connection: ${result.connection}<br>
                                Unanalyzed Entries Found: ${result.entries_found}
                            </div>
                        `;
                        
                        if (result.sample_entries && result.sample_entries.length > 0) {
                            alertsContainer.innerHTML += `<h4>📄 Sample Entries:</h4>`;
                            
                            result.sample_entries.forEach(entry => {
                                alertsContainer.innerHTML += `
                                    <div class="alert medium">
                                        <strong>Region ${entry.Maakunta_ID}:</strong> ${entry.Teema}<br>
                                        <strong>Date:</strong> ${entry.uutisen_pvm}<br>
                                        <strong>Status:</strong> ${entry.ai_status || 'pending'}<br>
                                        <small>${entry.Uutinen_preview}</small>
                                    </div>
                                `;
                            });
                            
                            if (result.entries_found > 0) {
                                alertsContainer.innerHTML += `
                                    <div class="alert medium" style="background: #e7f3ff;">
                                        <strong>🎉 Ready for Analysis!</strong><br>
                                        Found ${result.entries_found} entries ready to analyze.<br>
                                        <button class="btn" onclick="analyzeMediaseuranta()" style="margin-top: 10px;">📰 Start AI Analysis</button>
                                    </div>
                                `;
                            } else {
                                alertsContainer.innerHTML += `
                                    <div class="alert medium">
                                        <strong>ℹ️ All entries already analyzed</strong><br>
                                        <button class="btn" onclick="viewMediaseurantaInsights()" style="margin-top: 10px;">📊 View Results</button>
                                    </div>
                                `;
                            }
                        }
                        
                        updateStatus(`Data test successful - found ${result.entries_found} entries`, 'success');
                    }
                } else {
                    updateStatus('Test returned invalid response', 'error');
                }
                
            } catch (error) {
                console.error('Error in test:', error);
                updateStatus('Test failed - check console', 'error');
                
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = `
                    <div class="alert high">
                        <strong>❌ Test Error</strong><br>
                        Error: ${error.message}<br>
                        <small>Check network connection and server status.</small>
                    </div>
                `;
            }
            showLoading(false);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Load configuration first (single source of truth from PHP)
            await loadConfiguration();
            
            // Then initialize everything else
            initCharts();
            updateStatus('Dashboard ready - configuration loaded', 'success');
            
            console.log('Dashboard initialized with configuration:', {
                limit: OPENAI_ANALYSIS_LIMIT,
                source: CONFIG.source,
                message: CONFIG.development_status_message
            });
        });
    </script>
</body>
</html>
